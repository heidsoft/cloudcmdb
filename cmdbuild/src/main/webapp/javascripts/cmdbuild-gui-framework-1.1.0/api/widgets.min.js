!function(a){var i={saveMethod:a.Cmdbuild.widgets.SAVEONCARD,save:function(i,e){var t=this.formName(i,e),d=a.Cmdbuild.dataModel.forms[t];if(!d)return{};var l={};for(var n in d.checked){var s=d.checked[n];s&&(l[n]={})}return l},formName:function(a,i){var e=a+"_"+i._id+"grid";return e},cleanData:function(i,e){var t=this.formName(i,e);a.Cmdbuild.dataModel.cleanForm(t)}};a.Cmdbuild.widgets.LinkCards=i}(jQuery),function(a){var i={ROWBUTTONREGENERATE:"refresh",ROWBUTTONREPLY:"btnIconReply",ROWBUTTONDELETE:"deleteIconButton",ROWBUTTONMODIFY:"pencilGoIcon",mailAttributes:["account","bcc","body","cc","date","delay","from","_id","keepSynchronization","noSubjectPrefix","notifyWith","promptSynchronization","status","subject","template","to"],template2MailTable:{account:"account",bccAddresses:"bcc",content:"body",toAddresses:"to",ccAddresses:"cc",fromAddress:"from",subject:"subject"},saveMethod:a.Cmdbuild.widgets.SAVEAFTER,save:function(i,e){var t=(this.formName(i,e),a.Cmdbuild.dataModel.forms[i]);if(!t)return{};var d={data:t.getBackendData().mails,bkData:t.getBackendData().bkMails,name:e._id};return d},formName:function(a,i){var e=a+"_"+i._id+"formattachements";return e},cleanData:function(i,e){var t=this.formName(i,e);a.Cmdbuild.dataModel.cleanForm(t)},prepareFields:function(a){for(var i=0;i<a.data.templates.length;i++)a.data.templates[i]=this.template2Mail(a.data.templates[i])},evaluateCql:function(i,e){for(var t=0;t<e.data.templates.length;t++){e.data.templates[t]=e.data.templates[t];var d=e.data.templates[t],l=this.getAttributes(i,e,d,t);this.compileAttributes(i,l),d.attributes=l}a.Cmdbuild.CqlManager.variablesTable.generate(i,a.Cmdbuild.CqlManager.commandsTable)},createField:function(a,i,e,t,d){d.push({name:a,filter:{text:e[a],params:e.variables}})},getAttributes:function(a,i,e,t){var d=[];return this.createField("subject",i._id,e,t,d),this.createField("body",i._id,e,t,d),this.createField("to",i._id,e,t,d),this.createField("from",i._id,e,t,d),this.createField("cc",i._id,e,t,d),this.createField("bcc",i._id,e,t,d),d},setSynchronization:function(a,i,e,t){for(var d=0;d<a.length;d++){var l=a[d];l.promptSynchronization=!1,e&&i[l._id]?l.keepSynchronization=!0:l.keepSynchronization=!1}},compileAttributes:function(i,e){for(var t=0;t<e.length;t++)a.Cmdbuild.CqlManager.compileAttribute(i,e[t])},initialize:function(i,e){var t=a.Cmdbuild.dataModel.forms[i],d=t.getBackendData();d.mails=[],d.bkMails=[];for(var l=0;l<e.data.templates.length;l++){var n=e.data.templates[l],s="guiTmpMail_"+l;n._id=s,d.mails.push({_id:s,status:"draft"}),a.Cmdbuild.widgets.ManageEmail.cqlResolve(i,n,function(){},this)}this.loadMails(t.config,t.getBackend(),function(){},this)},refreshCqlField:function(i,e){var t=a.Cmdbuild.dataModel.forms[i];if(1!=t.initializationPhase&&this.busy!==!0){this.busy=!0;try{for(var d=0;d<e.data.templates.length;d++){var l=e.data.templates[d],n=l.keepSynchronization,s=l.promptSynchronization;if(n)if(s){if(t.initializationPhase===!1){var r=i+"_"+e._id;a.Cmdbuild.dataModel.pushSingleParameterOnStack("widgetName",r),a.Cmdbuild.dataModel.pushSingleParameterOnStack("formData",i),a.Cmdbuild.standard.commands.navigate({command:"navigate",form:"mailSynchronization",dialog:"syncMailDialog"}),l.promptSynchronization=!1}}else a.Cmdbuild.widgets.ManageEmail.cqlResolve(i,l,function(){},this);else;}}catch(o){console.log("Warning: Cmdbuild.widgets.ManageEmail.refreshCqlField ",i),m.busy=!1}var m=this;this.TM=setTimeout(function(){m.busy=!1},500)}},loadMails:function(i,e,t,d){i.cardId?a.Cmdbuild.utilities.proxy.getProcessMails(i.className,i.cardId,function(a){this.callbackLoadMails(e,i.className,i.cardId,a,t,d)},this):t.apply(d,[])},callbackLoadMails:function(i,e,t,d,l,n){if(d.length<=0)return void l.apply(n);var s=d[0];d.splice(0,1),a.Cmdbuild.utilities.proxy.getProcessSingleMail(e,t,s._id,function(s){i.data.mails.push(s),i.data.bkMails.push(a.Cmdbuild.utilities.clone(s)),this.callbackLoadMails(i,e,t,d,l,n)},this)},template2Mail:function(a){var i={};for(var e in a)this.template2MailTable[e]?i[this.template2MailTable[e]]=a[e]:i[e]=a[e];return i}};a.Cmdbuild.widgets.ManageEmail=i,a.Cmdbuild.widgets.ManageEmail.cqlResolveSingleField=function(i,e,t,d,l){var n=a.Cmdbuild.dataModel.forms[i],s=n.getBackendData();a.Cmdbuild.CqlManager.resolve(i,e,function(i){var n=a.Cmdbuild.widgets.ManageEmail.getMail(s.mails,t._id);n[e]=i,n.fromTemplate=t._id,d&&d.apply(l,[i])},this)},a.Cmdbuild.widgets.ManageEmail.cqlResolve=function(i,e,t,d){var l=e.attributes.slice();a.Cmdbuild.widgets.ManageEmail.cqlResolveCallback(i,e,l,function(){t.apply(d,[])},this)},a.Cmdbuild.widgets.ManageEmail.cqlResolveCallback=function(i,e,t,d,l){if(t.length<=0)return void d.apply(l,[]);var n=t[0];t.splice(0,1),a.Cmdbuild.widgets.ManageEmail.cqlResolveSingleField(i,n.name,e,function(){a.Cmdbuild.widgets.ManageEmail.cqlResolveCallback(i,e,t,d,l)},this)},a.Cmdbuild.widgets.ManageEmail.refreshTemplate=function(i,e,t){for(var d=0;d<e.data.templates.length;d++){var l=e.data.templates[d];if(l._id==t){a.Cmdbuild.widgets.ManageEmail.cqlResolve(i,l,function(){},this);break}}},a.Cmdbuild.widgets.ManageEmail.getMail=function(a,i){for(var e=0;e<a.length;e++)if(a[e]._id==i)return a[e]},a.Cmdbuild.widgets.ManageEmail.isDifferent=function(i,e){for(var t=0;t<a.Cmdbuild.widgets.ManageEmail.mailAttributes.length;t++){var d=a.Cmdbuild.widgets.ManageEmail.mailAttributes[t];if(e[d]!=i[d])return!0}return!1},a.Cmdbuild.widgets.ManageEmail.copyMail=function(i){for(var e={},t=0;t<a.Cmdbuild.widgets.ManageEmail.mailAttributes.length;t++){var d=a.Cmdbuild.widgets.ManageEmail.mailAttributes[t];e[d]=i[d]}return e},a.Cmdbuild.widgets.ManageEmail.deleteMails=function(i,e){for(var t=0;t<e.bkData.length;t++){for(var d=!1,l=e.bkData[t],n=0;n<e.data.length;n++){var s=e.data[n];if(l._id==s._id){d=!0;break}}d||a.Cmdbuild.utilities.proxy.deleteProcessMail(i.type,i.id,l._id,function(){},this)}},a.Cmdbuild.widgets.ManageEmail.flush=function(i,e,t,d,l,n){if(!e.data)return l||console.log(Error().stack),void l.apply(n,[]);var s=e.data.slice();a.Cmdbuild.widgets.ManageEmail.flushRecursive(i,s,e.bkData,function(){this.deleteMails(i,e),l.apply(n,[])},this)},a.Cmdbuild.widgets.ManageEmail.flushRecursive=function(i,e,t,d,l){if(e.length<=0)return void d.apply(l,[]);var n=e[0];e.splice(0,1);var s=a.grep(t,function(a){return a._id==n._id});if(s.length>0){var r=s[0];if(a.Cmdbuild.widgets.ManageEmail.isDifferent(r,n)){var o=a.Cmdbuild.widgets.ManageEmail.copyMail(n);a.Cmdbuild.utilities.proxy.putProcessMail(i.type,i.id,o._id,o,function(){a.Cmdbuild.widgets.ManageEmail.flushRecursive(i,e,t,d,l)},this)}else a.Cmdbuild.widgets.ManageEmail.flushRecursive(i,e,t,d,l)}else{var o=a.Cmdbuild.widgets.ManageEmail.copyMail(n);o._id;delete o._id,a.Cmdbuild.utilities.proxy.postProcessMail(i.type,i.id,o,function(){a.Cmdbuild.widgets.ManageEmail.flushRecursive(i,e,t,d,l)},this)}}}(jQuery),function(a){var i={data:{},saveMethod:a.Cmdbuild.widgets.SAVEAFTER,save:function(i,e){return{data:a.Cmdbuild.dataModel.getAttachmentsForWidget(i).slice(),name:e._id}},formName:function(a,i){return i.formname=a+"_"+i._id+"formattachements",i.formname},cleanData:function(i,e){var t=this.formName(i,e);a.Cmdbuild.dataModel.cleanForm(t)}};a.Cmdbuild.widgets.OpenAttachment=i,a.Cmdbuild.widgets.OpenAttachment.flush=function(i,e,t,d,l,n){var s=a.Cmdbuild.widgets.OpenAttachment.formName(d,{_id:t}),r=a.Cmdbuild.dataModel.getAttachmentsForWidget(s);if(r.length<=0)return void l.apply(n,[]);var o=r.splice(0,1)[0];a.Cmdbuild.dataModel.setAttachmentsForWidget(i.form,r),a.Cmdbuild.utilities.proxy.postInstanceAttachment(i.type,i.id,o.formdata,function(s){a.Cmdbuild.widgets.OpenAttachment.flush(i,e,t,d,l,n)},this)}}(jQuery);
//# sourceMappingURL=widgets.min.js.map