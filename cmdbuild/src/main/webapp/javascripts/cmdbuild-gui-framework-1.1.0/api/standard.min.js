!function(e){var t={tab:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t);e("#"+i.form).tabs("option","active",t.activeTab)},navigate:function(t){try{var i=e.Cmdbuild.elementsManager.getElement(t.form),a=e.Cmdbuild.utilities.getFields(i);a&&a.fields&&(a.form=t.form,e.Cmdbuild.dataModel.putFormFields(a)),e.Cmdbuild.utilities.include(i,this.navigateIncludeCB,{xmlForm:i,param:t},void 0)}catch(n){console.log("Commands navigate "+n.message,t,n.stack)}},navigateIncludeCB:function(t){var i=t.xmlForm,a=t.param;e.Cmdbuild.elementsManager.getParams(i,a);var n=e.Cmdbuild.elementsManager.isObserving(i,a.form),d=e.Cmdbuild.standard[a.type]||e.Cmdbuild.custom[a.type];if(!a.type||!d)throw new e.Cmdbuild.errorsManager.getError({message:e.Cmdbuild.errorsManager.CMERROR,type:e.Cmdbuild.errorsManager.PARAMNOTCORRECT,param:"type",method:"navigate",element:a.form});if(!n||"true"===a.fromObserving){var r=e.Cmdbuild.dataModel.resolveVariables(a);try{var s=d,l=void 0;e.Cmdbuild.dataModel.forms[a.form]?l=e.Cmdbuild.dataModel.forms[a.form]:(l=new s,e.Cmdbuild.dataModel.forms[a.form]=l),e.Cmdbuild.standard.contextStack.pop(r),e.Cmdbuild.standard.contextStack.push(r),l.init(r)}catch(o){console.log(o,o.stack)}}},advance:function(t){try{if(t.formObject=e.Cmdbuild.dataModel.forms[t.form],!e.Cmdbuild.dataModel.change(t))return;e.Cmdbuild.dataModel.flush(t,function(i){if(t.dialog)return void e.Cmdbuild.standard.commands.dialogClose(t);var a=e.Cmdbuild.dataModel.model[t.form].data;return a._id||(a._id=i,a._type=t.formObject.config.className),t.navigationForm?void e.Cmdbuild.standard.commands.navigate({form:t.navigationForm,container:t.navigationContainer}):void e.Cmdbuild.utilities.proxy.getActivity(a._type,a._id,function(i){if(0!=i.length)e.Cmdbuild.standard.commands.navigate({form:t.form,container:t.container,className:a._type,cardId:a._id,activityInstanceId:i[0]._id});else if(t.tab){var n=e.Cmdbuild.dataModel.resolveVariables(t);e("#"+n.tabbedForm).tabs("option","active",t.tab)}},this)})}catch(i){e.Cmdbuild.errorsManager.popup(i)}},save:function(t){try{if(t.ldap&&e.Cmdbuild.ldap.write({form:t.form,ldapDescriptor:t.ldap}),t.formObject=e.Cmdbuild.dataModel.forms[t.form],!e.Cmdbuild.dataModel.change(t))return;if(e.Cmdbuild.dataModel.flush(t,function(i){return t.dialog?void e.Cmdbuild.standard.commands.dialogClose(t):void 0}),t.navigationForm)return void e.Cmdbuild.standard.commands.navigate({form:t.navigationForm,container:t.navigationContainer})}catch(i){e.Cmdbuild.errorsManager.popup(i)}},cancel:function(t){try{var i=e.Cmdbuild.elementsManager.getElement(t.form);if(e.Cmdbuild.elementsManager.getParams(i,t),t.backend=e.Cmdbuild.utilities.getBackend(t.backend),t.formObject=e.Cmdbuild.dataModel.forms[t.form],e.Cmdbuild.dataModel.reset(t),t.navigationForm)return void e.Cmdbuild.standard.commands.navigate({form:t.navigationForm,container:t.navigationContainer})}catch(a){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.commands.cancel"),a}},dialogExec:function(t){$select=e("#"+t.toExecCommand),$select.trigger("itemselectedfromgrid"),e("#"+t.dialog).dialog("close")},dialogClose:function(t){if(t.dialog){var i=e.Cmdbuild.dataModel.resolveVariables(t);e("#"+i.dialog).dialog("close")}},dialogCancel:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t);i.form&&i.selection&&e.Cmdbuild.standard.grid.cancelSelection(i.form),e("#"+i.dialog).dialog("close")},fieldChanged:function(t){var i=e("#"+t.id),a=i.attr("name");a&&""!=a||(a=i.attr("fieldName"),e.Cmdbuild.errorsManager.warn("Attribute fieldName is deprecated. Use name."));var n=i.attr("form");n&&""!=n||(n=i.attr("formName"),e.Cmdbuild.errorsManager.warn("Attribute formName is deprecated. Use form.")),e.Cmdbuild.CqlManager.fieldChanged(n,a)},deleteRow:function(t){var i=e.Cmdbuild.dataModel.forms[t.form],a=i.getBackend();a.deleteRow({form:t.form})},attach:function(t){var i=e.Cmdbuild.dataModel.forms[t.form],a=i.getBackend(),n=[],d=e("#"+t.description).val(),r=e("#"+t.category).val(),s=document.getElementById(t.id).files[0],l=e("#"+t.id).val();if(s||n.push({field:e("#"+t.id).attr("fieldName"),errorType:e.Cmdbuild.global.NOVALUEONREQUIREDFIELD}),""==e.trim(d)&&n.push({field:e("#"+t.description).attr("fieldName"),errorType:e.Cmdbuild.global.NOVALUEONREQUIREDFIELD}),""==e.trim(r)&&n.push({field:e("#"+t.category).attr("fieldName"),errorType:e.Cmdbuild.global.NOVALUEONREQUIREDFIELD}),n.length>0)return void e.Cmdbuild.errorsManager.popupOnRequestFields(n);var o=new FileReader;o.readAsText(s),o.onload=function(i){var n=new FormData;n.append("file",s),n.append("attachment",new Blob([JSON.stringify({_description:d,_category:r})],{type:"application/json"})),e("#"+t.description).val(""),e("#"+t.category).val(""),e("#"+t.id).val(""),a.addRow({form:param.form,row:{description:d,category:r,document:l,formdata:n}})}},fieldRefresh:function(t){var i=e.Cmdbuild.dataModel.forms[t.form];i.refreshField(t)},reportParamsSend:function(t){try{if(t.type="form",!e.Cmdbuild.dataModel.change(t))return;var i=e.Cmdbuild.dataModel.getValues(t.form),a={};for(var n in i){var d=n.replace(/_PT_/g,".");d=d.replace(/_SP_/g," "),a[d]=i[n]}var r=e.Cmdbuild.utilities.getBackend(t.backend);r.showReport(a)}catch(s){e("#"+t.dialog).dialog("close"),e.Cmdbuild.errorsManager.log(s),e.Cmdbuild.errorsManager.popup(s)}e("#"+t.dialog).dialog("close")},requestReportParameters:function(t){var i=e.Cmdbuild.utilities.getBackend(t.backend);e.Cmdbuild.utilities.setAttributesInteractivity(t.attributes);for(var a=0;a<t.attributes.length;a++)t.attributes[a].name=t.attributes[a].name.replace(/[.]/g,"_PT_"),t.attributes[a].name=t.attributes[a].name.replace(/[ ]/g,"_SP_");i.data.attributes=t.attributes,e.Cmdbuild.standard.commands.navigate(t)},printReport:function(t){var i=e.Cmdbuild.elementsManager.getElement(t.form),a={};e.Cmdbuild.elementsManager.getParams(i,a);var n=e.Cmdbuild.utilities.getBackend(a.backend),d=e.Cmdbuild.dataModel.getValue(t.form,"id"),r=e.Cmdbuild.dataModel.getValue(t.form,"type");t.typeReport=r,t.id=d,t.form=t.formDialog,n.requestReport(t)},saveattachments:function(e){this.dialogClose(e)},deleteMail:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t),a=e.Cmdbuild.dataModel.forms[i.formData],n=a.getBackend();n.deleteMail(i),this.refreshGrid(i,function(){})},replyMail:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t);e.Cmdbuild.standard.commands.navigate({form:i.navigationForm,dialog:i.navigationDialog})},refreshMail:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t),a=e.Cmdbuild.dataModel.forms[i.formData],n=e.Cmdbuild.dataModel.getValues(i.form),d=a.getBackend().widgets;e.Cmdbuild.dataModel.detachObserving(),e.Cmdbuild.widgets.refreshTemplate(i.formData,d,n.fromTemplate),e.Cmdbuild.dataModel.attachObserving();var r=this;this.TM=setTimeout(function(){r.refreshGrid(i,function(){})},500)},refreshGrid:function(t,i,a){var n=e("#"+t.form).DataTable();n.ajax.reload(function(e){i&&i.apply(a)})},synchronizeMails:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t),a=e.Cmdbuild.dataModel.getWidgetWindow(i.widgetName),n=e.Cmdbuild.standard.grid.getChecked(i.form),d=a.data.type,r=a.data.templates,s=e.Cmdbuild.standard.widgetDiv.widgetName(d);e.Cmdbuild.widgets[s]&&e.Cmdbuild.widgets[s].setSynchronization&&e.Cmdbuild.widgets[s].setSynchronization(r,n,!0,!1);for(var l=0;l<r.length;l++){var o=r[l];"true"==n[o._id]&&e.Cmdbuild.widgets.ManageEmail.cqlResolve(i.formData,o,function(){},this)}e("#"+i.dialog).dialog("close")},noSynchronizeMails:function(t){var i=e.Cmdbuild.dataModel.resolveVariables(t),a=e.Cmdbuild.dataModel.getWidgetWindow(i.widgetName),n=a.data.templates,d=a.data.type,r=e.Cmdbuild.standard.widgetDiv.widgetName(d);e.Cmdbuild.widgets[r]&&e.Cmdbuild.widgets[r].setSynchronization&&e.Cmdbuild.widgets[r].setSynchronization(n,{},!1,!1),e("#"+i.dialog).dialog("close")},downloadAttachment:function(t){var i,a=e.Cmdbuild.dataModel.resolveVariable(t.className),n=e.Cmdbuild.dataModel.resolveVariable(t.cardId),d=e.Cmdbuild.dataModel.resolveVariable(t.attachmentName),r=e.Cmdbuild.dataModel.resolveVariable(t.attachmentId);e.Cmdbuild.dataModel.isAClass(a)?i=e.Cmdbuild.global.getApiUrl()+"classes/"+a+"/cards/"+n:e.Cmdbuild.dataModel.isAProcess(a)&&(i=e.Cmdbuild.global.getApiUrl()+"processes/"+a+"/instances/"+n);var s=i+"/attachments/"+r+"/"+encodeURIComponent(d)+"?CMDBuild-Authorization="+e.Cmdbuild.authentication.getAuthenticationToken();window.location.replace(s)}};e.Cmdbuild.standard.commands=t}(jQuery),function(e){var t={NUMROWGRIDREFERENCE:10};e.Cmdbuild.standard.configuration=t}(jQuery),function(e){var t=function(){this.param=void 0,this.init=function(t){try{this.param=t,this.show()}catch(i){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.init"),i}},this.show=function(){try{var t=e.Cmdbuild.elementsManager.getElement(this.param.form);e.Cmdbuild.eventsManager.deferEvents();var i="";i+=e.Cmdbuild.elementsManager.insertChildren(t);var a=e.Cmdbuild.utilities.getWidgetsFromXML(t),n=[];a&&a.length&&e.each(a,function(e,t){n.push(t)}),n&&n.length&&(e.Cmdbuild.widgets.prepareFields(n),i+=e.Cmdbuild.standard.widgetDiv.getWidgetDiv({container:this.param.container,form:this.param.form,readOnly:this.param.readonly,widgets:n}));var d=e("#"+this.param.container)[0];d.innerHTML=i,e.Cmdbuild.elementsManager.initialize(),e.Cmdbuild.eventsManager.unDeferEvents()}catch(r){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.show"),r}}};e.Cmdbuild.standard.div=t}(jQuery),function(e){var t={canvas3d:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);i+="<div  "+a+"></div>";var n=e.Cmdbuild.elementsManager.getXmlElementId(t);return e.Cmdbuild.scriptsManager.push({script:"canvas3d",id:n}),i},dialog:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);i+="<div"+a+"></div>";var n=e.Cmdbuild.elementsManager.getXmlElementId(t);return e.Cmdbuild.scriptsManager.push({script:"dialog",id:n}),i},spinner:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.elementsManager.insertLabel(t),d=e.Cmdbuild.elementsManager.getEvent("onChange",t),r=e.Cmdbuild.elementsManager.getParams(t),s=r.value,l="<input  "+a+" name='value' valueType='spinner' value='"+s+"'></input>",o=e.Cmdbuild.elementsManager.getXmlElementId(t);e.Cmdbuild.scriptsManager.push({script:"spinner",id:o,spin:d,value:s,min:r.min?r.min:1,max:r.max?r.max:1e5});var i=e.Cmdbuild.elementsManager.wrapInFormRow(n,l,"input");return i},checkbox:function(t){var i=e.Cmdbuild.elementsManager.getXmlElementId(t),a=t.getAttribute("text");a=a?a:"false";var n=e.Cmdbuild.elementsManager.getCommonAttributes(t),d=e.Cmdbuild.utilities.getEventLikeString(t,"onClick");e.Cmdbuild.scriptsManager.push({script:"checkbox",id:i});var r="";"true"==a&&(r=" checked ");var s=e.Cmdbuild.elementsManager.insertLabel(t),l="<input type='checkbox'"+r+n+d+"value='"+a+"' />",o=e.Cmdbuild.elementsManager.wrapInFormRow(s,l,"checkbox");return o},button:function(t){var i=e.Cmdbuild.elementsManager.getParams(t),a=e.Cmdbuild.dataModel.resolveVariables(i);if(void 0!==a.condition&&!a.condition)return"";var n="";n+=e.Cmdbuild.elementsManager.insertLabel(t);var d=e.Cmdbuild.elementsManager.getText(t),r=e.Cmdbuild.elementsManager.getCommonAttributes(t),s=e.Cmdbuild.utilities.getEventLikeString(t,"onClick"),l="true"==a.readOnly?" disabled ":"";n+="<input type='button'"+r+s+l+" value='"+d+"' />",n+=e.Cmdbuild.elementsManager.insertReturn(t);var o=e.Cmdbuild.elementsManager.getXmlElementId(t);return i&&e.Cmdbuild.dataModel.prepareCallerParameters(o,i),e.Cmdbuild.scriptsManager.push({script:"button",id:o}),n},upload:function(t){var i=e.Cmdbuild.elementsManager.insertLabel(t),a=e.Cmdbuild.elementsManager.getText(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t),d=e.Cmdbuild.utilities.getEventLikeString(t,"onChange"),r=a+": <input type='file' name='filename'"+n+d+" />";r+=e.Cmdbuild.elementsManager.insertReturn(t);var s=e.Cmdbuild.elementsManager.wrapInFormRow(i,r,"upload");return s},iframe:function(t){var i=e.Cmdbuild.utilities.escapeHtml(t.getAttribute("src")),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n="<iframe src='"+i+"'"+a+"/>";return n+=e.Cmdbuild.elementsManager.insertReturn(t)},title:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.utilities.getEventLikeString(t,"onClick"),d="<h2 "+n+a+" >"+i+"</h2>";return d+=e.Cmdbuild.elementsManager.insertReturn(t)},p:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.utilities.getEventLikeString(t,"onClick"),d="<span "+n+a+" >"+i+"</span>";return d+=e.Cmdbuild.elementsManager.insertReturn(t)},span:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.utilities.getEventLikeString(t,"onClick"),d="<span "+n+a+" >"+i+"</span>";return d+=e.Cmdbuild.elementsManager.insertReturn(t)},h1:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n="<h1 "+a+">"+i+"</h1>";return n},h2:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n="<h2 "+a+">"+i+"</h2>";return n},h3:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n="<h3 "+a+">"+i+"</h3>";return n},br:function(e){var t="<br />";return t},img:function(t){var i="",a=t.getAttribute("src");if(!a){var n=e.Cmdbuild.elementsManager.getParams(t),d=e.Cmdbuild.dataModel.resolveVariables(n);a=d.src}var r=e.Cmdbuild.elementsManager.getCommonAttributes(t);return i+="<img"+r+"src='"+a+"' />",i+=e.Cmdbuild.elementsManager.insertReturn(t)},input:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.elementsManager.insertLabel(t),d="",r=t.getAttribute("interactivity"),s=r&&r==e.Cmdbuild.global.READ_ONLY,l=t.getAttribute("maxlength");null!==l&&(a+=" maxlength='"+l+"' "),s?(d=i,d+="<input type='hidden'"+a+"value='"+(i?i:"")+"' />"):d="<input type='text'"+a+"value='"+i+"' />";var o=e.Cmdbuild.elementsManager.wrapInFormRow(n,d,"input",s);return o},integer:function(t){var i=e.Cmdbuild.elementsManager.getText(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.elementsManager.insertLabel(t),d="",r=t.getAttribute("interactivity"),s=r&&r==e.Cmdbuild.global.READ_ONLY;s?(d+=i,d+="<input type='hidden'"+a+"value='"+(i?i:"")+"' />"):d+="<input type='text'"+a+"value='"+i+"' />";var l=e.Cmdbuild.elementsManager.wrapInFormRow(n,d,"integer",s),o=e.Cmdbuild.elementsManager.getXmlElementId(t);return e.Cmdbuild.scriptsManager.push({script:"integer",id:o}),l},date:function(t){var i=e.Cmdbuild.elementsManager.getCommonAttributes(t),a=e.Cmdbuild.elementsManager.getXmlElementId(t),n=e.Cmdbuild.elementsManager.getParams(t),d=t.getAttribute("text");d=d||"",d=e.Cmdbuild.utilities.convertDateDB2GUI(d,n.type),e.Cmdbuild.scriptsManager.push({script:"date",id:a,type:n.type});var r,s=e.Cmdbuild.elementsManager.insertLabel(t),l=t.getAttribute("interactivity"),o=l&&l==e.Cmdbuild.global.READ_ONLY;o?(r=d,r+="<input isDate='"+n.type+"' type='hidden'"+i+"value='"+(d?d:"")+"' />"):r="<input isDate='"+n.type+"' type='text'"+i+"value='"+d+"' />";var u=e.Cmdbuild.elementsManager.wrapInFormRow(s,r,"date",o);return u},textarea:function(t){var i=e.Cmdbuild.elementsManager.getXmlElementId(t),a=e.Cmdbuild.elementsManager.getParams(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t),d=e.Cmdbuild.elementsManager.insertLabel(t),r="",s=a&&a.isHtml?!0:!1,l=t.getAttribute("rows"),o=t.getAttribute("cols"),u="";u=!s&&a&&a.rawText?a.rawText.trim():e.Cmdbuild.elementsManager.getText(t);var m=t.getAttribute("interactivity"),c=m&&m==e.Cmdbuild.global.READ_ONLY,g=t.getAttribute("maxlength");if(null!==g&&(n+=" maxlength='"+g+"' "),c){if(s){var h=document.createElement("div");h.innerHTML=u,h.childNodes.length&&(r='<div class="textareaReadOnly">'+h.childNodes[0].nodeValue+"</div>")}else r=u.replace(/(?:\r\n|\r|\n)/g,"<br />");r+="<textarea class='hiddentextarea'>"+(u?u:"")+"</textarea>"}else r="<textarea  cols='"+o+"' rows='"+l+"' type='text'"+n+"value='"+u+"'>"+u+"</textarea>";var b=e.Cmdbuild.elementsManager.wrapInFormRow(d,r,"textarea",c);return s&&(a={script:"htmlText",id:i},e.Cmdbuild.scriptsManager.push(a)),b},lookup:function(t){var i,a=e.Cmdbuild.elementsManager.getXmlElementId(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t),d=e.Cmdbuild.elementsManager.getParams(t),r=e.Cmdbuild.utilities.getEventLikeString(t,"onChange"),s=e.Cmdbuild.elementsManager.insertLabel(t),l=t.getAttribute("interactivity"),o=l&&l==e.Cmdbuild.global.READ_ONLY;o?i="<input type='hidden'"+n+"value='"+(""|d.value)+"' />":(i="",i+="<select "+n+r+">",i+="</select>",i+="");var u=e.Cmdbuild.elementsManager.wrapInFormRow(s,i,"lookup",o);return d={script:"lookup",id:a,backend:d.backend,lookupName:d.lookupName,value:d.value,readOnly:o},e.Cmdbuild.scriptsManager.push(d),u},select:function(t){var i=e.Cmdbuild.elementsManager.getXmlElementId(t),a=e.Cmdbuild.elementsManager.getCommonAttributes(t),n=e.Cmdbuild.elementsManager.getParams(t),d=e.Cmdbuild.utilities.getEventLikeString(t,"onChange");n=e.extend({script:"select",id:i},n),e.Cmdbuild.scriptsManager.push(n);var r=e.Cmdbuild.elementsManager.insertLabel(t),s="<select "+a+d+">";s+="</select>";var l=t.getAttribute("interactivity"),o=l&&l==e.Cmdbuild.global.READ_ONLY,u=e.Cmdbuild.elementsManager.wrapInFormRow(r,s,"select",o);return u},reference:function(t){var i,a,n=e.Cmdbuild.elementsManager.getXmlElementId(t),d=e.Cmdbuild.elementsManager.getCommonAttributes(t),r=e.Cmdbuild.elementsManager.getParams(t),s=r.backend,l=e.Cmdbuild.elementsManager.insertLabel(t),o=t.getAttribute("interactivity"),u=o&&o==e.Cmdbuild.global.READ_ONLY;if(u)i="<input type='hidden'"+d+"value='"+(""|r.value)+"' />";else{a='$.Cmdbuild.standard.referenceField.onSearchLookup("'+n+'", "'+r.container+'")';var m='$.Cmdbuild.standard.referenceField.onClearLookup("'+n+'")';r.toExecCommand=n,i="<select "+d+" backend='"+s+"' className='"+r.className+"' eventSearch = '"+a+"'>",i+="<option selected></option>",i+="</select>";var c=t.getAttribute("formName"),g=t.getAttribute("fieldName");r.fieldName=g,r.formName=c,i+=this.lookupButtons(n,r.container,a,m),this.lookupDialog(n,r)}var h=e.Cmdbuild.elementsManager.wrapInFormRow(l,i,"reference",u);return r={script:"reference",id:n,eventSearch:a,backend:r.backend,className:r.className,value:r.value,readOnly:u,formNRows:r.formNRows},e.Cmdbuild.scriptsManager.push(r),h},openEntry:function(t,i){var a="",n="",d=e.Cmdbuild.elementsManager.getText(t),r=e.Cmdbuild.elementsManager.getCommonAttributes(t),s=e.Cmdbuild.elementsManager.getXmlElementId(t),l=e.Cmdbuild.elementsManager.getParams(t),o=e.Cmdbuild.dataModel.resolveVariables(l);if(o&&e.Cmdbuild.dataModel.prepareCallerParameters(s,o),0==o.show||1==o.hide)return"";var u=e.Cmdbuild.utilities.getEventLikeString(t,"onClick",'$.Cmdbuild.utilities.currentMenu("'+s+'", "'+i+'");return false;');if(a+="<li "+r+"><span class='ui-icon ui-icon-carat-1-e'></span><a id='"+s+"_aElement' title='"+n+"' href='#'"+u+">"+d+"</a>",t.childNodes.length>0){a+="<ul class='ui-menu'>";for(var m=0;m<t.childNodes.length;m++)"openEntry"==t.childNodes[m].nodeName&&(a+=this.openEntry(t.childNodes[m],i));a+="</ul>"}return a+="</li>",e.Cmdbuild.scriptsManager.push({script:"openMenu",id:s+"_aElement"}),a},openMenu:function(t){var i="",a=e.Cmdbuild.elementsManager.getXmlElementId(t);i+="<ul id='"+a+"' class='ui-menu'>";for(var n=0;n<t.childNodes.length;n++)"openEntry"==t.childNodes[n].nodeName&&(i+=this.openEntry(t.childNodes[n],a));return i+="</ul>"},text:function(t){var i="";i+=e.Cmdbuild.elementsManager.insertLabel(t);var a=e.Cmdbuild.elementsManager.getText(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t);return i+="<span"+n+">"+a+"</span>",i+=e.Cmdbuild.elementsManager.insertReturn(t)},entry:function(t){var i="",a=e.Cmdbuild.elementsManager.getText(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t),d=e.Cmdbuild.utilities.getEventLikeString(t,"onClick");i+="<li"+n+"><a href='#'"+d+">"+a+"</a>";var r=e.Cmdbuild.elementsManager.insertChildren(t);return""!=r&&(i+="<ul>"+r+"</ul>"),i+="</li>"},menu:function(t){var i="",a=e.Cmdbuild.elementsManager.getText(t),n=e.Cmdbuild.elementsManager.getCommonAttributes(t);i+="<ul"+n+">";var d=e.Cmdbuild.elementsManager.getXmlElementId(t);return null!=a&&(i+="<a href='#'>"+a+"</a>"),i+=e.Cmdbuild.elementsManager.insertChildren(t),i+="</ul>",i+=e.Cmdbuild.elementsManager.insertReturn(t),e.Cmdbuild.scriptsManager.push({script:"menu",id:d}),i},divform:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);return i+="<div"+a+"/>"},div:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);i+="<div"+a+">",i+=e.Cmdbuild.elementsManager.insertChildren(t),i+="</div>";var n=e.Cmdbuild.elementsManager.getXmlElementId(t),d=e.Cmdbuild.elementsManager.getEvent("onInit",t),r=e.Cmdbuild.elementsManager.getParams(t);return e.Cmdbuild.dataModel.prepareCallerParameters(n,r),d&&(d.script="init",d.id=n,e.Cmdbuild.scriptsManager.push(d)),i},dl:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);return i+="<dl"+a+">",i+=e.Cmdbuild.elementsManager.insertChildren(t),i+="</dl>"},dd:function(t){var i="",a=e.Cmdbuild.elementsManager.getCommonAttributes(t);return i+="<dd"+a+">",i+=e.Cmdbuild.elementsManager.insertChildren(t),i+="</dd>"},override:function(t){var i=t.getAttribute("container"),a=e("#"+i)[0],n=e.Cmdbuild.elementsManager.insertChildren(t);return a.innerHTML=n,""},gridNavigationBar:function(t){var i="",a={};e.Cmdbuild.elementsManager.getParams(t,a);var n=a.form;return i+="<input type='text' id='"+n+"_filtertext' />",i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_filter","ui-icon-search",'$.Cmdbuild.standard.gridMenu.onFilter("'+n+'", "")'),i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_clearFilter","ui-icon-closethick",'$.Cmdbuild.standard.gridMenu.onClearFilter("'+n+'")'),i+="<span id='"+n+"_pageCount' class='cmdbuildGridNavigationCount'></span>",i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_init","ui-icon-arrowthickstop-1-w",'$.Cmdbuild.standard.gridMenu.onNavigate("begin", "'+n+'")'),i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_previous","ui-icon-arrowthick-1-w",'$.Cmdbuild.standard.gridMenu.onNavigate("previous", "'+n+'")'),i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_next","ui-icon-arrowthick-1-e",'$.Cmdbuild.standard.gridMenu.onNavigate("next", "'+n+'")'),i+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",n+"_end","ui-icon-arrowthickstop-1-e",'$.Cmdbuild.standard.gridMenu.onNavigate("end", "'+n+'")')},grid:function(t){var i=e.Cmdbuild.elementsManager.getXmlElementId(t),a="<table id='"+i+"' class='display' style='width: 100%;'></table>",n={script:"grid",id:i};return e.Cmdbuild.elementsManager.getParams(t,n),n.onClick=e.Cmdbuild.elementsManager.getEvent("onClick",t),e.Cmdbuild.scriptsManager.push(n),a},lookupButtons:function(t,i,a,n){var d="";return d+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",t+"_search","ui-icon-search",a),d+=e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",t+"_clearFilter","ui-icon-closethick",n)},lookupDialog:function(t,i){var a="<form id='"+t+"_dialog' >";a+="<params>",a+="<type>popup</type>",a+="</params>",a+="<div id='"+t+"_dialogDiv' class='cmdbuildDialogContentWrapper'>",a+="<onInit>",a+="<command>navigate</command>",a+="<container>"+t+"_dialogDiv</container>",a+="<form>"+t+"_dialogGrid</form>",a+="<formName>"+i.formName+"</formName>",a+="<fieldName>"+i.fieldName+"</fieldName>",a+="</onInit>",a+="<form id='"+t+"_dialogGrid'>",a+="<params>",a+="<type>grid</type>",a+="<className>"+i.className+"</className>",a+="<backend>"+i.backend+"</backend>",a+="<nRows>"+e.Cmdbuild.global.configurationValue("NUMROWGRIDREFERENCE")+"</nRows>",a+="<lookup>true</lookup>",a+="<navigation>false</navigation>",a+="<sort>Description</sort>",a+="<direction>asc</direction>",a+="</params>",a+="<onDblClick>",a+="<command>dialogExec</command>",a+="<toExecCommand>"+i.toExecCommand+"</toExecCommand>",a+="<bReference>"+i.bReference+"</bReference>",a+="<dialog>"+t+"_lookupDialog</dialog>",a+="</onDblClick>",a+="</form>",a+="</div>",a+="<div class='cmdbuildFooterButtonsWrapper'>",a+="<button text='Ok' id='"+t+"_dialogOk'>",a+="<onClick>",a+="<command>dialogExec</command>",a+="<toExecCommand>"+i.toExecCommand+"</toExecCommand>",a+="<bReference>"+i.bReference+"</bReference>",a+="<dialog>"+t+"_lookupDialog</dialog>",a+="</onClick>",a+="</button>",a+="<button text='Cancel' id='"+t+"_dialogCancel'>",a+="<onClick>",a+="<command>dialogClose</command>",a+="<dialog>"+t+"_lookupDialog</dialog>",a+="</onClick>",a+="</button>",a+="</div>",a+="</form>";var n=new DOMParser;xDoc=n.parseFromString(a,"text/xml");var d=xDoc.documentElement,r=e.Cmdbuild.elementsManager.getElement(i.container);r.appendChild(d)}};e.Cmdbuild.standard.elements=t}(jQuery),function(e){function t(t){var i={};return e.each(t,function(e,t){t.defaultValue?i[t.name]=t.defaultValue:i[t.name]=void 0}),i}function i(e){var t=[];if(e.filter(function(e){var i=e.group;return i&&i.trim()?i.trim():i=s,-1==t.indexOf(i)&&t.push(i)}),-1!==t.indexOf(s)){var i=t.indexOf(s),a=t.length-1;t=r(t,i,a)}return t}function a(t){var i=e("<form></form>").attr("action","#").attr("name",t).attr("id",t);return i}function n(t,i){var a=e("<div></div>").attr("id",t+"_tabbed"),n=e("<ul></ul>");return a.append(n),e.each(i,function(i,r){var l=e("<li></li>"),o=r;o===s&&(o="Other");var u=e("<a></a>").attr("href","#"+d(t,r)).text(o);n.append(l.append(u));var m=e("<div></div>").attr("id",d(t,r));a.append(m)}),a.tabs(),a}function d(e,t){return t=t?t:s,t=t.replace(/[^a-z0-9\s]/gi,"").replace(/[_\s]/g,"-").toLowerCase(),e+"-tab-"+t}function r(e,t,i){for(;0>t;)t+=e.length;for(;0>i;)i+=e.length;if(i>=e.length)for(var a=i-e.length;a--+1;)e.push(void 0);return e.splice(i,0,e.splice(t,1)[0]),e}var s="_NOGROUP_",l=function(){this.config={},this.backend=void 0,this.customFields=[],this.customWidgets=[],this.xmlForm=void 0,this.init=function(t){this.config=t,this.xmlForm=e.Cmdbuild.elementsManager.getElement(this.config.form),this.customFields=e.Cmdbuild.utilities.getFields(this.xmlForm),this.customWidgets=e.Cmdbuild.utilities.getWidgetsFromXML(this.xmlForm);try{var i=e.Cmdbuild.utilities.getBackend(t.backend),a=new i(t,this.show,this);this.setBackend(a)}catch(n){console.log("WARNING: No data message "+n.message);var d=e("#"+this.param.container)[0];d.innerHTML="<h1>NO DATA</h1>"}},this.show=function(){var d=this,r=this.config.form,l=this.getBackendAttributes();if(e.Cmdbuild.dataModel.evaluateJSONAttributes(l,this.customFields),e.Cmdbuild.CqlManager.compile(r,l),this.config.emptyForm&&"true"==this.config.emptyForm){var o=t(l);this.setBackendData(o)}e.Cmdbuild.dataModel.push({form:this.config.form,type:"form",data:this.getBackendData()});var u=e("#"+this.config.container);u.empty();var m=a(this.config.form);u.append(m);var c,g=!1;this.config.noGroup&&"true"==this.config.noGroup?c=[s]:(c=i(l),c.length>1&&(g=!0,m.append(n(r,c))));var h=this.getBackendData(),b={onsubmit:!1,ignore:"input:hidden, textarea:hidden",rules:{},messages:{},errorPlacement:function(e,t){e.insertBefore(t),t.parents("dl").addClass("cmdbuildGuiFormFieldError")},success:function(e){e.parents("dl").removeClass("cmdbuildGuiFormFieldError")}};e.each(l,function(t,i){var a=h[i._id];d.config.readonly&&"true"==d.config.readonly&&(i.writable=!1);var n=e.Cmdbuild.fieldsManager.generateHTML(i,r,d.config.container,a),s=e.Cmdbuild.fieldsManager.getFieldValidator(i);if(s&&s.rules&&!e.isEmptyObject(s.rules)&&(b.rules[i._id]=s.rules),g){var l=d.getTabId(r,i.group);e("#"+l).append(n)}else m.append(n)}),m.validate(b),this.updateWidgets();var p=this.getBackendWidgets();if(p&&p.length){e.Cmdbuild.widgets.prepareFields(p);var f=e.Cmdbuild.standard.widgetDiv.getWidgetDiv({container:this.config.container,form:this.config.form,readOnly:this.config.readonly,widgets:p}),C=e(f);C.find("input[type=button]").button();var v=C.filter("div[id$='_widgetDialog']").remove();m.append(C),v.dialog({autoOpen:!1,modal:!0,show:{effect:"fade",duration:250},hide:{effect:"explode",duration:500}}),e.Cmdbuild.widgets.evaluateCqlFields(this.config.form,p,!0),e.Cmdbuild.widgets.initialize(this.config.form,p)}var M=e.Cmdbuild.utilities.getButtonsFromXML(this.xmlForm);if(M){var k=e(M);k.find("input[type=button]").button(),m.append(k)}var w=e.Cmdbuild.elementsManager.insertChildren(this.xmlForm);w&&m.append(w),this.config.onInitComplete&&window[this.config.onInitComplete]()},this.getTabId=d,this.refreshField=function(t){var i=e.Cmdbuild.fieldsManager.getFieldId(t.form,t.field),a=e("#"+i);a.length?a.trigger("refreshfield"):e.Cmdbuild.widgets.refreshCqlField(t.form,this.getBackend().widgets)},this.getValue=function(t){var i=e.Cmdbuild.fieldsManager.getFieldId(t.form,t.field),a=e.Cmdbuild.utilities.getHtmlFieldValue("#"+i);return null===a&&(a=e.Cmdbuild.dataModel.getValue(t.form,t.field)),a},this.flush=function(e,t,i){this.getBackend().updateData(e,t,i)},this.change=function(t){var i=[],a=e("#"+this.config.form),n=this.getBackendAttributes();if(a.valid())e.each(n,function(i,a){var n=e.Cmdbuild.fieldsManager.getFieldId(t.form,a._id);t.data[a._id]=e.Cmdbuild.utilities.getHtmlFieldValue("#"+n)});else{var d=a.validate().errorList;e.each(d,function(t,a){var d=e(a.element).attr("name"),r=e.grep(n,function(e){return e._id==d}),s=r.length>0?r[0]:null;s&&i.push({field:s.description,message:a.message})})}return i},this.reset=function(t){for(var i in t.data){var a=e.Cmdbuild.fieldsManager.getFieldId(t.form,i),n=e("#"+a);n&&n.val(t.data[i])}},this.getClientDescription=function(e,t,i){var a=this.getBackendAttributes(),n=this.getValue(e);this.getDescription(e,a,n,function(e){t.apply(i,[e])},this)},this.getServerDescription=function(t,i,a){if(!this.getBackend().getOriginalAttributes)return console.log("Backend without original attributes on form: "+t.form,this.getBackend()),void i.apply(a,[""]);var n=this.getBackend().getOriginalAttributes(),d=e.Cmdbuild.dataModel.getValue(t.form,t.field);this.getDescription(t,n,d,function(e){i.apply(a,[e])},this)},this.getDescription=function(t,i,a,n,d){for(var r=void 0,s=0;s<i.length;s++)if(i[s].name==t.field){r=i[s];break}r&&a?e.Cmdbuild.utilities.getFieldDescription(r,a,function(e){n.apply(d,[e])}):n.apply(d,[a||""])},this.updateWidgets=function(){var t=this.getBackendWidgets();this.customWidgets&&this.customWidgets.length&&(void 0===t&&(t=[]),e.each(this.customWidgets,function(e,i){t.push(i)}),this.setBackendWidgets(t))},this.getBackend=function(){return this.backend},this.setBackend=function(e){this.backend=e},this.getBackendData=function(){var e=this.getBackend();return e.getData?e.getData():(console.warn("Missing getData method for backend "+this.config.backend),e.data)},this.setBackendData=function(e){var t=this.getBackend();t.setData?t.setData(e):(console.warn("Missing setData method for backend "+this.config.backend),t.data=e)},this.getBackendAttributes=function(){var e=this.getBackend();return e.getAttributes?e.getAttributes():(console.warn("Missing getAttributes method for backend "+this.config.backend),e.attributes)},this.setBackendAttributes=function(e){var t=this.getBackend();t.setAttributes?t.setAttributes(e):(console.warn("Missing setAttributes method for backend "+this.config.backend),t.attributes=e)},this.getBackendWidgets=function(){var e=this.getBackend();return e.getWidgets?e.getWidgets():(console.warn("Missing getWidgets method for backend "+this.config.backend),e.widgets)},this.setBackendWidgets=function(e){var t=this.getBackend();t.setWidgets?t.setWidgets(e):(console.warn("Missing setWidgets method for backend "+this.config.backend),t.widgets=e)}};e.Cmdbuild.standard.form=l}(jQuery),function(e){var t=function(){
this.param=void 0,this.init=function(t){try{this.param=t,this.show()}catch(i){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.init"),i}},this.show=function(){try{var t=e.Cmdbuild.elementsManager.getElement(this.param.form);e.Cmdbuild.eventsManager.deferEvents();var i="";i+=e.Cmdbuild.elementsManager.insertChildren(t);var a=e("#"+this.param.container)[0];i+="<div id='container'>",i+="<style> #graph-container { top: 0; bottom: 0; left: 0; right: 0; position: absolute;} </style>",i+="<div id='graph-container'></div></div>",a.innerHTML=i,e.Cmdbuild.scriptsManager.push({script:"graph",id:"graph-container",className:this.param.className,cardId:this.param.cardId}),e.Cmdbuild.elementsManager.initialize(),e.Cmdbuild.eventsManager.unDeferEvents()}catch(n){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.show"),n}}};e.Cmdbuild.standard.graph=t}(jQuery),function(e){function t(t){return t.emptyGridI18nMessage?e.Cmdbuild.translations.getTranslation(t.emptyGridI18nMessage,t.emptyGridMessage?t.emptyGridMessage:t.emptyGridI18nMessage):t.emptyGridMessage?t.emptyGridMessage:""}var i=13,a=function(){this.currentPage=0,this.nRows=10,this.paginationSettings={},this.checked={},this.bkChecked={},this.config={},this.id=null,this.init=function(t){if(this.config=t,t.selectedItemId){var i=e.Cmdbuild.dataModel.resolveVariable(this.config.selectedItemId);t.positionOf=i}var a=e.Cmdbuild.utilities.getBackend(t.backend);this.backend=new a(this.config,this.onBackendLoaded,this)},this.onBackendLoaded=function(){var a=this.config;this.bkChecked=e.Cmdbuild.utilities.clone(this.checked),this.id=a.form;var n=e.Cmdbuild.elementsManager.getElement(this.id);e.Cmdbuild.elementsManager.getRowButtons(n,a),e.Cmdbuild.elementsManager.getColumnsCommands(n,a);var d=e.Cmdbuild.utilities.getFields(n);d&&d.fields&&(d.form=this.id,e.Cmdbuild.dataModel.putFormFields(d)),this.onDblClick=e.Cmdbuild.elementsManager.getEvent("onDblClick",n),this.paginationSettings={nRows:a.nRows||nRows,nTotalRows:0,firstRow:0,condition:a.condition,hookParent:"true"===a.hookParent,parent:a.parent,singleSelect:1==a.singleSelect?!0:!1,onClick:e.Cmdbuild.elementsManager.getEvent("onClick",n),onChange:e.Cmdbuild.elementsManager.getEvent("onChange",n),className:a.className,cardId:a.cardId,allowSorting:a.allowSorting&&"false"==a.allowSorting?!1:!0,allowScrollX:a.allowScrollX&&"false"==a.allowScrollX?!1:!0,fixedLeftColumns:a.fixedLeftColumns?a.fixedLeftColumns:0,fixedRightColumns:a.fixedRightColumns?a.fixedRightColumns:0,onInitComplete:a.onInitComplete?a.onInitComplete:null,emptyGridMessage:t(a),rawParam:a};var r="true"==a.withComboProcesses?this.gridHeader(this.id):"";"true"==a.lookup&&(r+=this.gridButtons(this.id)),r+="<table id='"+this.id+"' class='display' width='100%'></table>",e.Cmdbuild.eventsManager.deferEvents();var s=e("#"+a.container)[0];r+=e.Cmdbuild.elementsManager.insertChildren(n),"false"!=a.navigation&&(r+=this.gridButtons(this.id)),s.innerHTML=r,e.Cmdbuild.elementsManager.initialize(),e.Cmdbuild.eventsManager.unDeferEvents();var l=this.id;e("#"+this.id+"_filtertext").keypress(function(t){return t.which==i?(e.Cmdbuild.standard.grid.onFilter(l),!1):void 0}),this.chargeFilter()},this.reset=function(e){alert("grid reset "+e.type+" "+e.form)},this.change=function(e){alert("grid change "+e.type+" "+e.form)},this.chargeFilter=function(){this.paginationSettings.backend=this.backend;var t=this.paginationSettings.rawParam;t.grid=this,t.fieldName&&t.formName?e.Cmdbuild.CqlManager.resolve(t.formName,t.fieldName,this.show,this):this.show("")},this.show=function(t){var i=this.paginationSettings.backend;i.noValidFilter=void 0===t,this.paginationSettings.backend=this.backend;try{this.updateFirstRowFromSelectedItem();var a=this.paginationSettings.rawParam;a.grid=this,a.fieldName&&a.formName&&t&&(this.paginationSettings.backend.filter.CQL=t),e.Cmdbuild.dataModel.evaluateXmlAttributes(this.id,this.paginationSettings.backend.getAttributes()),this.showAttributes(a);var n=this,d=a.sort?this.getIndexColumn(a.sort):this.getFirstValidColumn(),r=a.direction?a.direction.toLowerCase():"asc",s=void 0,l=void 0,o=void 0;a.scroll&&(s=a.scrollHeight+"px",l=!0,o=!1);var u=e("#"+this.id).dataTable({scrollY:s,scrollCollapse:l,paging:o,pageLength:n.nRows,lengthChange:!1,bProcessing:!0,bServerSide:!0,searching:!1,paging:!1,scrollX:n.paginationSettings.allowScrollX,info:!1,ordering:n.paginationSettings.allowSorting,aaSorting:[[d,r]],ajax:function(t,i,a){var d=n.getParamFormLoadData(a);n.paginationSettings.backend.loadData(d,function(){var t={data:n.getData()};if(i(t),n.convertReferencedValues(),t.data&&t.data.length){var a=0;if(n.paginationSettings.rawParam.selectedItemId){var d=this.paginationSettings.backend.positions,r=this.paginationSettings.rawParam.selectedItemId;if(d&&r){var s=d[r];if(s){var l=this.paginationSettings.nRows;a=s%l,this.paginationSettings.rawParam.selectedItemId=void 0}}}var o=e("#"+n.id+' tbody tr:not(".cmdbuildGroupByHeader"):eq('+a+")"),u=e("#"+n.id).DataTable();n.paginationSettings.hookParent&&n.paginationSettings.parent.getSelection?n.selectRows(n.paginationSettings.parent.getSelection()):n.selectRow(n.id,u,o,a,!1),n.onLoad(),n.disableRowButtons()}else e.Cmdbuild.dataModel.setCurrentIndex(n.id,-1),n.onLoad()},n)},columns:n.paginationSettings.attributesInGrid,columnDefs:n.getNoAttributeColumns(),fnInitComplete:n.paginationSettings.onInitComplete?e.Cmdbuild.dataModel.resolveVariable(n.paginationSettings.onInitComplete):null,drawCallback:function(e){n.drawCallback(this,n,a,e)},language:{zeroRecords:n.paginationSettings.emptyGridMessage}});if(a.groupBy){var m=e("#"+this.id).DataTable();m.columns([0]).visible(!1,!1),m.order([[0,"asc"]])}new e.fn.dataTable.FixedColumns(u,{iLeftColumns:n.paginationSettings.fixedLeftColumns,iRightColumns:n.paginationSettings.fixedRightColumns}),u.on("order.dt",function(){e(e.fn.dataTable.tables(!0)).DataTable().columns.adjust()}),e("#"+this.id+" tbody").on("click","tr",function(t){var i=e(this).parents("table");n.id=i.attr("id");var d=e("#"+n.id).DataTable();(!e(this).hasClass("selected")||n.paginationSettings.hookParent)&&n.selectRow(a.form,d,e(this),d.row(this).index(),t.ctrlKey),e.Cmdbuild.eventsManager.onEvent(n.paginationSettings.onClick)}),this.onDblClick&&e("#"+n.id+" tbody").on("dblclick","tr",function(){e.Cmdbuild.eventsManager.executeEvent(n.onDblClick)}),e("#"+this.id+" tbody").on("click","span",function(t){var i=e(this).parents("table");n.id=i.attr("id");var d=e("#"+n.id).DataTable(),r=e(this).parents("tr");n.selectRow(a.form,d,r,d.row(r).index(),t.ctrlKey);var s=jQuery.parseJSON(e(this).attr("method"));e.Cmdbuild.eventsManager.onEvent(s)})}catch(c){throw e.Cmdbuild.errorsManager.log(c),c}},this.disableRowButtons=function(){var t=this.id,i=0,a=this.paginationSettings.backend;e("#"+t+" tbody tr").each(function(t){if(!e(this).hasClass("cmdbuildGroupByHeader")&&a.disableRowButtons){for(var n=a.disableRowButtons(i),d=0;d<n.length;d++){var r=e(this).find("."+n[d]);e(r).removeClass(n[d])}i++}})},this.onLoad=function(){this.paginationSettings.hookParent&&this.paginationSettings.parent.onLoad&&this.paginationSettings.parent.onLoad()},this.convertReferencedValues=function(){for(var t=e("#"+this.id).DataTable(),i=this.paginationSettings.backend,a=i.getData(),n=0;n<a.length;n++)for(var d=0;d<this.paginationSettings.attributesInGrid.length;d++)this.convertReferencedValue(a,t,n,d)},this.convertReferencedValue=function(t,i,a,n){var d=t[a],r=this.paginationSettings.attributesInGrid[n],s=d[r.name];r&&s?e.Cmdbuild.utilities.getFieldDescription(r,s,function(e){i.cell(a,n).data(e),i.columns.adjust()}):(i.cell(a,n).data(s||""),i.columns.adjust())},this.addColumnsCommands=function(){var t=this.paginationSettings.rawParam.columnsCommands,i=this,a=[];return e.each(t,function(e,t){var n=i.getIndexColumn(t.attribute);a.push({targets:n,mRender:function(e,i,a){var n="";if(e){var d=t.tooltip?" title = '"+t.tooltip+"' ":"";n="<span "+d+" class='commandcell "+t.icon+"' method='"+JSON.stringify(t.onClick)+"'>"+e+"</span>"}return n}})}),a},this.drawCallback=function(t,i,a,n){if(a.groupBy){var d=t.api(),r=d.rows({page:"current"}).nodes(),s=null;d.column(0,{page:"current"}).data().each(function(t,i){s!==t&&(e(r).eq(i).before('<tr class="cmdbuildGroupByHeader"><td colspan="5">'+t+"</td></tr>"),s=t)})}},this.selectRows=function(t){for(var i=e("#"+this.id).DataTable(),a=this.paginationSettings.backend.getData(),n=0;n<a.length;n++){var d=a[n],r=i.row(n).node();t[d.id]?e(r).addClass("selected"):e(r).removeClass("selected")}},this.selectRow=function(t,i,a,n,d){e.Cmdbuild.dataModel.setCurrentIndex(t,n),i.$("tr.selected").removeClass("selected"),a.addClass("selected"),this.paginationSettings.onChange&&(this.paginationSettings.onChange.addSelection=d,e.Cmdbuild.eventsManager.onEvent(this.paginationSettings.onChange))},this.getNoAttributeColumns=function(){for(var t=[],i=this.paginationSettings.backend.getAttributes(),a=0,n=0;i&&n<i.length;n++){var d=i[n];if(d.displayableInList===!0||"true"===d.displayableInList){if("IMAGEBUTTON"==d.type){var r=d.tooltip?" title = '"+d.tooltip+"' ":"";t.push({width:20,targets:a,data:null,title:"&nbsp;",orderable:!1,defaultContent:"<span "+r+" class='"+d.className+"' method='"+d.onClick+"'></span>"})}else if("ROWSELECTIONCHECK"==d.type){var s=this,r=d.tooltip?" title = '"+d.tooltip+"' ":"";t.push({width:20,targets:a,data:null,title:"&nbsp;",orderable:!1,render:function(e,t,i,a){var n=e[0]?" checked ":"";return"<input name='rowSelectionCheck' "+r+" type='checkbox' "+n+" onclick='$.Cmdbuild.standard.grid.clickOnCheck(this, \""+s.id+"\")'>"}})}a++}}var l=this.addColumnsCommands();return e.merge(t,l)},this.getFirstValidColumn=function(){for(var e=0;e<this.paginationSettings.attributesInGrid.length;e++){var t=this.paginationSettings.attributesInGrid[e].type;if("IMAGEBUTTON"!=t&&"ROWSELECTIONCHECK"!=t)return e}},this.showAttributes=function(t){try{t.rowButtons&&e.Cmdbuild.elementsManager.loadIconButtons(this.paginationSettings.backend.getAttributes(),t.rowButtons,t.positionButtons),"true"===t.selection&&e.Cmdbuild.elementsManager.pushSelectionCheck(this.paginationSettings.backend.getAttributes(),"left"),this.paginationSettings.attributesInGrid=[];for(var i=0;i<this.paginationSettings.backend.getAttributes().length;i++){var a=this.paginationSettings.backend.getAttributes()[i];(a.displayableInList===!0||"true"===a.displayableInList)&&this.paginationSettings.attributesInGrid.push({name:a.name,title:a.description,tooltip:a.tooltip,type:a.type,length:a.length,targetClass:a.targetClass,lookupType:a.lookupType,scale:a.scale})}}catch(n){e.Cmdbuild.errorsManager.log(n)}},this.getIndexColumn=function(e){for(var t=0;t<this.paginationSettings.attributesInGrid.length;t++)if(this.paginationSettings.attributesInGrid[t].name==e)return t;return 0},this.getParamFormLoadData=function(e){return param=this.paginationSettings,param.sort=this.paginationSettings.attributesInGrid[e.aaSorting[0][0]].name,param.direction="asc"==e.aaSorting[0][1]?"ASC":"DESC",param.form||(param.form=this.id),param},this.getData=function(){try{"true"===this.paginationSettings.rawParam.selectionDefault&&this.selectAll();var t=this.paginationSettings.backend,i=t.getData();e.Cmdbuild.dataModel.push({form:this.id,type:"grid",currentIndex:t.getTotalRows()>0?0:-1,data:i});for(var a=[],n=0;n<i.length;n++){for(var d=i[n],r=[],s=0;s<this.paginationSettings.attributesInGrid.length;s++){var l=void 0;l="selectionCheck"==this.paginationSettings.attributesInGrid[s].name?this.checked[d._id]:this.getFieldValue(d,this.paginationSettings.attributesInGrid[s]),r.push(l)}a.push(r)}return this.paginationSettings.nTotalRows=t.getTotalRows(),this.enableGridButtons(this.id),this.setPageCount(this.id),a}catch(o){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.grid.getData "+o.message),o}},this.getFieldValue=function(t,i){return t[i.name]?"lookup"==i.type?"":"reference"==i.type?"":-1!=["date","time","timestamp","dateTime"].indexOf(i.type)?e.Cmdbuild.utilities.convertDateDB2GUI(t[i.name],i.type):t[i.name]||"":""},this.gridHeader=function(t){var i="<div class='cmdbuildGridHeaderWrapper'>",a=t+"_processStatuses",n=" id='"+a+"' class='cmdbuildGridProcessStatuses' ",d=" onChange='$.Cmdbuild.standard.grid.onSelectStatus(\""+a+'", "'+this.id+"\")'";i+="<select "+n+d+">",i+="</select>";var r={script:"select",id:a,backend:"Select",processName:this.paginationSettings.className,value:"$fromBackend"};return e.Cmdbuild.scriptsManager.push(r),i+="</div>"},this.newgridButtons=function(e){var t="<div class='cmdbuildGridNavigationWrapper'>";return t+="<div class='cmdbuildGridFilterContainer'>",t+="<!--[if IE]><br/><input type='text' ",t+=" size='20' value='Ignore field IE bug fix'",t+="/><br/><![endif]-->",t+="<input type='text' id='"+e+"_filtertext' />",t+=this.gridButton(e+"_filter","ui-icon-search",'$.Cmdbuild.standard.gridMenu.onFilter("'+e+'")'),t+=this.gridButton(e+"_clearFilter","ui-icon-closethick",'$.Cmdbuild.standard.gridMenu.onClearFilter("'+e+'")'),t+="</div>",t+="<div class='cmdbuildGridNavigationContainer'>",t+=this.gridButton(e+"_init","ui-icon-arrowthickstop-1-w",'$.Cmdbuild.standard.gridMenu.onNavigate("begin", "'+e+'")'),t+=this.gridButton(e+"_previous","ui-icon-arrowthick-1-w",'$.Cmdbuild.standard.gridMenu.onNavigate("previous", "'+e+'")'),t+=this.gridButton(e+"_next","ui-icon-arrowthick-1-e",'$.Cmdbuild.standard.gridMenu.onNavigate("next", "'+e+'")'),t+=this.gridButton(e+"_end","ui-icon-arrowthickstop-1-e",'$.Cmdbuild.standard.gridMenu.onNavigate("end", "'+e+'")'),t+="<p id='"+e+"_pageCount' class='cmdbuildGridNavigationCount'>Page 1 of 123</p>",t+="</div>",t+='<div class="cmdbuildClear"></div>',t+="</div>"},this.gridButtons=function(e){var t="<div class='cmdbuildGridNavigationWrapper'>";return t+="<div class='cmdbuildGridFilterContainer'>",t+="<input type='text' id='"+e+"_filtertext' />",t+=this.gridButton(e+"_filter","ui-icon-search",'$.Cmdbuild.standard.grid.onFilter("'+e+'")'),t+=this.gridButton(e+"_clearFilter","ui-icon-closethick",'$.Cmdbuild.standard.grid.onClearFilter("'+e+'")'),t+="</div>",t+="<div class='cmdbuildGridNavigationContainer'>",t+=this.gridButton(e+"_init","ui-icon-arrowthickstop-1-w",'$.Cmdbuild.standard.grid.onNavigate("begin", "'+e+'")'),t+=this.gridButton(e+"_previous","ui-icon-arrowthick-1-w",'$.Cmdbuild.standard.grid.onNavigate("previous", "'+e+'")'),t+=this.gridButton(e+"_next","ui-icon-arrowthick-1-e",'$.Cmdbuild.standard.grid.onNavigate("next", "'+e+'")'),t+=this.gridButton(e+"_end","ui-icon-arrowthickstop-1-e",'$.Cmdbuild.standard.grid.onNavigate("end", "'+e+'")'),t+="<p id='"+e+"_pageCount' class='cmdbuildGridNavigationCount'>Page 1 of 123</p>",t+="</div>",t+='<div class="cmdbuildClear"></div>',t+="</div>"},this.enableGridButtons=function(t){var i=parseInt(this.paginationSettings.firstRow),a=parseInt(this.paginationSettings.nRows),n=parseInt(this.paginationSettings.nTotalRows);e("#"+t+"_init").button("option","disabled",0==i),e("#"+t+"_previous").button("option","disabled",0==i),e("#"+t+"_next").button("option","disabled",i+a>=n),e("#"+t+"_end").button("option","disabled",i+a>=n)},this.setPageCount=function(t){var i=parseInt(this.paginationSettings.firstRow),a=parseInt(this.paginationSettings.nRows),n=parseInt(this.paginationSettings.nTotalRows),d=e.Cmdbuild.utilities.formatVarString(e.Cmdbuild.global.GRIDROWSCOUNT,parseInt(i/a)+1,parseInt((n+a-1)/a),n);e("#"+t+"_pageCount").html(d)},this.gridButton=function(t,i,a){return e.Cmdbuild.elementsManager.makeServiceButton("cmdbuildButton",t,i,a)},this.getBackend=function(){return this.paginationSettings.backend},this.selectAll=function(){var e=this.paginationSettings.backend;this.checked={};for(var t=0;t<e.getTotalRows();t++)this.checked[e.data[t]._id]="true"},this.updateFirstRowFromSelectedItem=function(){var e=this.paginationSettings.backend.positions,t=this.paginationSettings.rawParam.selectedItemId;if(e&&t){var i=e[t];if(i){var a=this.paginationSettings.nRows,n=Math.floor(i/a)*a;this.paginationSettings.firstRow=n}}}};e.Cmdbuild.standard.grid=a,e.Cmdbuild.standard.grid.onSelectStatus=function(t,i){var a=e.Cmdbuild.utilities.getHtmlFieldValue("#"+t),n=e.Cmdbuild.dataModel.forms[i],d=n.getBackend();if(d.setFilter){d.setFilter({flowStatus:a});var r=e("#"+i).DataTable();r.ajax.reload(function(e){})}else e.Cmdbuild.errorsManager.log("The method setFilter is not defined on the grid backend")},e.Cmdbuild.standard.grid.onFilter=function(t){var i=e.Cmdbuild.dataModel.forms[t];i.paginationSettings.firstRow=0;var a=e("#"+t+"_filtertext").val();i.paginationSettings.backend.filter.query=e.trim(a);var n=e("#"+t).DataTable();n.ajax.reload(function(e){})},e.Cmdbuild.standard.grid.onClearFilter=function(t){var i=e.Cmdbuild.dataModel.forms[t];i.paginationSettings.firstRow=0,i.paginationSettings.backend.filter.query="",e("#"+t+"_filtertext").val("");var a=e("#"+t).DataTable();a.ajax.reload(function(e){})},e.Cmdbuild.standard.grid.cancelSelection=function(t){var i=e.Cmdbuild.dataModel.forms[t];i&&(i.checked=e.Cmdbuild.utilities.clone(i.bkChecked))},e.Cmdbuild.standard.grid.clearSelection=function(t){var i=e.Cmdbuild.dataModel.forms[t];i&&(i.checked={})},e.Cmdbuild.standard.grid.getChecked=function(t){var i=e.Cmdbuild.dataModel.forms[t];return i?i.checked:{}},e.Cmdbuild.standard.grid.clickOnCheck=function(t,i){var a=t.checked,n=e(t).parents("table"),d=n.attr("id"),r=e("#"+d).DataTable(),s=e(t).parents("tr"),l=e.Cmdbuild.dataModel.forms[i];l.selectRow(i,r,s,r.row(s).index());var o=e.Cmdbuild.dataModel.getValues(i),u=e(n).find("input[name='rowSelectionCheck']");l.paginationSettings.singleSelect&&(u.each(function(){this!=t&&e(this).attr("checked",!1)}),l.checked=[]),l.checked[o._id]=a},e.Cmdbuild.standard.grid.onNavigate=function(t,i){var a=e.Cmdbuild.dataModel.forms[i],n=parseInt(a.paginationSettings.firstRow),d=parseInt(a.paginationSettings.nRows),r=parseInt(a.paginationSettings.nTotalRows);switch(t){case"begin":n=0;break;case"end":n=r>0&&d>0?Math.floor(r/d)*d:0;break;case"previous":var s=n-d;n=s>0?s:0;break;case"next":n+=d;break;default:n=0}a.paginationSettings.firstRow=n;var l=e("#"+i).DataTable();l.ajax.reload(function(e){})}}(jQuery),function(e){var t=function(t){this.param=t,this.lookupTree={},this.lookupValue={},this.init=function(){if(!this.param.lookupType&&this.param.lookupName)this.param.lookupType=this.param.lookupName,console.warn("lookupName parameter is deprecated. Use lookupType.");else if(!this.param.lookupType&&!this.param.lookupName)return void e.Cmdbuild.errorsManager.error("No lookup type specified");this.param.value&&(this.lookupValue[this.param.lookupType]=this.param.value),this.generateLookupTypeTree(this.param.lookupType)},this.generateLookupTypeTree=function(t,i){var a=this;e.Cmdbuild.utilities.proxy.getLookupType(t,{},function(n,d){var r={type:n.name,values:[]};n.parent&&(r.parent=n.parent),i&&(r.child=i),e.Cmdbuild.utilities.proxy.getLookupData(t,{active:!0},function(t,i){if(r.values=t,a.lookupTree[n.name]=r,n.parent&&a.lookupValue[n.name]){var d=a.lookupValue[n.name],s=e.grep(t,function(e){return e._id==d});s.length&&(a.lookupValue[s[0].parent_type]=s[0].parent_id)}n.parent?a.generateLookupTypeTree(n.parent,n.name):a.generateHTML()},this)},this)},this.generateHTML=function(){var t=e("#"+this.param.id),i=this.param.lookupType;if(this.param.readOnly)return void this.showReadOnlyLookup(i);if(!this.lookupTree[i])return void console.log("NOT FOUND : this.lookupTree["+i+"]");if(this.lookupTree[i].parent){if(t.attr("rel",this._getRelValueByType(i)),t.selectmenu("widget").addClass("selectmenu-newrow"),this.lookupValue[i]){var a=this.lookupTree[i].parent,n=this.lookupValue[a];this.updateChildSelect(i,n)}this.addParentSelect(this.lookupTree[this.param.lookupType].parent,t)}else this.addOptions(t,this.lookupTree[i].values)},this.addOptions=function(t,i){t.empty();var a=this,n=e("<option>");t.append(n),e.each(i,function(i,n){var d=e("<option>").attr("value",n._id);d.text(n.description),a.lookupValue[n._type]==n._id&&d.attr("selected","selected"),t.append(d)}),t.selectmenu("refresh")},this.addParentSelect=function(t,i){var a=this,n=this.lookupTree[t],d=e("<select>");d.attr("rel",this._getRelValueByType(t)),i.before(d),i.before("<div></div>"),d.selectmenu({change:function(e,t){a.updateChildSelect(n.child,t.item.value)}}),n.parent?selectfield.selectmenu().addClass("selectmenu-newrow"):this.addOptions(d,n.values)},this.updateChildSelect=function(t,i){var a=this.lookupTree[t],n=[],d=e("select[rel='"+this._getRelValueByType(t)+"']");e.each(a.values,function(e,t){t.parent_id==i&&n.push(t)}),this.addOptions(d,n)},this.showReadOnlyLookup=function(t){if(!e.isEmptyObject(this.lookupValue)){var i=this.lookupTree[t].values,a=this.lookupValue[t],n=this.getSelectedItem(i,a),d=e("#"+this.param.id);n&&(d.after(n.description),n.parent_type&&(d.after(" / "),this.showReadOnlyLookup(n.parent_type)))}},this.getSelectedItem=function(t,i){var a;return e.each(t,function(e,t){t._id==i&&(a=t)}),a},this._getRelValueByType=function(e){return this.param.id+e},this.init()};e.Cmdbuild.standard.lookupField=t,e.Cmdbuild.standard.lookupField.setValue=function(t,i){var a=e("#"+t);a.val(""),a.selectmenu("refresh")},e.Cmdbuild.standard.lookupField.clearValue=function(t){var i=e("#"+t);i.val(""),i.selectmenu("refresh")}}(jQuery),function(e){var t="selectedNavItem",i="cmdbuild_navigation",a=function(){this.id=null,this.config={},this.backend=void 0,this.tree={},this.init=function(t){this.config=t,this.id=t.form,t.labelField||(t.labelField="_description"),t.idField||(t.idField="_id");var i=e.Cmdbuild.utilities.getBackend(t.backend);this.backend=new i(t,this.onInitComplete,this)},this.onInitComplete=function(){var e={},t=this;this.backend.loadData(e,function(){t.show()},this)},this.show=function(){var a=this.backend.getData();e.Cmdbuild.dataModel.push({form:this.id,type:"navigation",currentIndex:-1,data:a});try{this.organizeTree()}catch(n){e.Cmdbuild.errorsManager.popup(n)}var s=e("#"+this.config.container),l=this.generateUL("root",this.config.form,i);s.append(l),this.config.collapsible&&(r.walk(this.config.form),s.addClass("collapsibleNavigation")),d(this.config.form,0),s.children("ul").children("li:first-child").children("a:first-child").addClass(t)},this.organizeTree=function(){this.tree={};var t=this,i=this.config.parentField;if(!i){var a=new Error("Missing parentField parameter.");throw a.name="ConfigurationError",a}e.each(this.backend.getData(),function(e,a){var n=a[i];n||null!==n||(n="root"),-1===Object.keys(t.tree).indexOf(n.toString())&&(t.tree[n]=[]),t.tree[n].push(a)})},this.generateUL=function(i,a,r){var s=this,l="rel-itemid",o=this.config.labelField,u=this.config.idField,m=e("<ul></ul>");a&&m.attr("id",a),r&&m.addClass(r);var c=this.tree[i];return c&&e.each(c,function(i,a){var r=a[u],c=e("<li></li>"),g=e("<a></a>").attr("href","#").attr(l,r).text(a[o]).click(function(){var i=e(this);e("#"+s.config.container+" ."+t).removeClass(t),i.addClass(t);var a=n(s.backend.getData(),u,i.attr(l));return d(s.config.form,a),!1});c.append(g),-1!==Object.keys(s.tree).indexOf(r.toString())&&c.append(s.generateUL(r.toString())),m.append(c)}),m}},n=function(e,t,i){for(var a=0;a<e.length;a+=1)if(e[a][t]==i)return a},d=function(t,i){e.Cmdbuild.dataModel.setCurrentIndex(t,i)},r={collapse:function(e){e.slideToggle(500)},walk:function(t){var i=this;e("a","#"+t).each(function(){var t,a=e(this);a.parent();if(a.next().is("ul")){var n=a.next();t=e("<span></span>").addClass("navCommandIcon"),t.click(function(e){e.preventDefault(),i.collapse(n),t.toggleClass("active")})}else t=e("<span></span>").addClass("navBullet").html("&bull;");a.before(t)})}};e.Cmdbuild.standard.navigation=a}(jQuery),function(e){var t=function(){this.param=void 0,this.init=function(t){try{this.param=t,this.show()}catch(i){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.init"),i}},this.show=function(){try{e.Cmdbuild.eventsManager.deferEvents();var t=e("#"+this.param.dialog),i=e.Cmdbuild.elementsManager.getElement(this.param.form),a=e.Cmdbuild.elementsManager.insertChildren(i);t.html(a),t.dialog("option","dialogClass",e.Cmdbuild.global.getThemeCSSClass());var n=this.param.width,d=this.param.height;t.dialog("option","height",d||e.Cmdbuild.global.modalMaxHeight),t.dialog("option","width",n||e.Cmdbuild.global.modalMaxWidth);var r=this.param.title,s=this.param.i18nTitle;s&&(r=e.Cmdbuild.translations.getTranslation(s,r)),t.dialog("option","title",r).dialog("open"),e.Cmdbuild.elementsManager.initialize(),e.Cmdbuild.eventsManager.unDeferEvents()}catch(l){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.div.show"),l}}};e.Cmdbuild.standard.popup=t}(jQuery),function(e){var t="CardList",i="ReferenceActivityList",a=function(t){this.config=t,this.backend=void 0,this.init=function(){this.config.displayAttribute||(this.config.displayAttribute="Description"),this.config.optionsLimit||(this.config.optionsLimit=e.Cmdbuild.global.getMaxLookupEntries());var t=r(this.config.targetType,this.config.targetClass),i=e.Cmdbuild.utilities.getBackend(t),a={className:this.config.targetClass};this.setBackend(new i(a,this.initReference,this))},this.initReference=function(){var t=this,i=e("#"+this.config.id);s(this.config.id+"_lookupDialog"),e.Cmdbuild.standard.elements.lookupDialog(this.config.id,{formName:i.attr("form"),fieldName:i.attr("name"),className:this.config.targetClass,backend:r(this.config.targetType,this.config.targetClass),toExecCommand:this.config.id,bReference:"",container:this.config.container}),i.on({clearreference:function(e){t.clear()},searchreferenceitem:function(i){var a=t.config.id;e.Cmdbuild.standard.commands.navigate({form:a+"_dialog",dialog:a+"_lookupDialog",title:"Reference values",width:"90%"})},itemselectedfromgrid:function(i){var a=e.Cmdbuild.dataModel.getValue(t.config.id+"_dialogGrid","_id");t.updateValue(a)},refreshfield:function(e){t.loadReference()}}),this.loadReference()},this.loadReference=function(){var t=this;if(this.config.readOnly)return void this.loadReadOnlyReference();var i=e("#"+this.config.id),a=i.attr("form"),n=i.attr("name");e.Cmdbuild.CqlManager.resolve(a,n,function(i){return void 0==i||e.Cmdbuild.CqlManager.isUndefined(i)?void t.addEmptyOption():(i&&(t.config.filter={CQL:i},t.getBackend().filter=this.config.filter),void t.loadData())},this)},this.loadReadOnlyReference=function(){var t=this;if(this.config.value){var i=e("#"+this.config.id),a=e("<span></span>").addClass("referenceLabel");i.after(a),n(this.config.targetType,this.config.targetClass)?e.Cmdbuild.utilities.proxy.getCardData(this.config.targetClass,this.config.value,{},function(e,i){a.text(e[t.config.displayAttribute])},this):e.Cmdbuild.utilities.proxy.getCardProcess(this.config.targetClass,this.config.value,{},function(e,i){a.text(e[t.config.displayAttribute])},this)}},this.addEmptyOption=function(){var t=e("#"+this.config.id);t.empty();var i=e("<option></option>").attr("selected","selected");t.append(i),t.val(""),this.fieldChanged()},this.addOptionsFromBackend=function(){var t=this,i=e("#"+this.config.id);i.empty(),i.append(e("<option></option>")),e.each(this.getBackend().getData(),function(a,n){var d=e("<option></option>").attr("value",n._id).text(n[t.config.displayAttribute]);n._id==t.config.value&&(d.attr("selected","selected"),i.val(t.config.value)),i.append(d)}),this.fieldChanged()},this.addOptionForCurrentValue=function(){var t=this,i=e("#"+this.config.id);i.empty(),n(this.config.targetType,this.config.targetClass)?e.Cmdbuild.utilities.proxy.getCardData(this.config.targetClass,this.config.value,{},function(a,n){i.append(e("<option></option>").attr("value",a._id).text(a[t.config.displayAttribute])),i.val(a._id),t.fieldChanged()},this):e.Cmdbuild.utilities.proxy.getCardProcess(this.config.targetClass,this.config.value,{},function(a,n){i.append(e("<option></option>").attr("value",a._id).text(a[t.config.displayAttribute])),i.val(a._id),t.fieldChanged()},this)},this.fieldChanged=function(){e.Cmdbuild.custom.commands&&e.Cmdbuild.custom.commands.fieldChanged?e.Cmdbuild.custom.commands.fieldChanged(this.config):e.Cmdbuild.standard.commands.fieldChanged(this.config),e("#"+this.config.id).selectmenu("refresh")},this.loadData=function(){var e=this,t={page:0,start:0,nRows:e.config.optionsLimit};this.getBackend().loadData(t,this.showReference,this)},this.showReference=function(t,i){var a=e("#"+this.config.id),n=this.getBackend().getTotalRows()<this.config.optionsLimit;n?this.addOptionsFromBackend():this.config.value?this.addOptionForCurrentValue():this.addEmptyOption(),n||a.selectmenu({open:function(t,i){e(t.target).trigger("searchreferenceitem")}})},this.updateValue=function(t){var i=this;this.config.value=t,this.getBackend().getTotalRows()<this.config.optionsLimit?(e("#"+i.config.id).val(t),i.fieldChanged()):i.addOptionForCurrentValue()},this.clear=function(){var t=e("#"+this.config.id),i=this.getBackend().getTotalRows()<this.config.optionsLimit;i?(t.val(""),this.fieldChanged()):this.addEmptyOption()},this.getBackend=function(){return this.backend},this.setBackend=function(e){this.backend=e},this.init()};e.Cmdbuild.standard.referenceField=a;var n=function(t,i){return t&&"class"===t||!t&&e.Cmdbuild.dataModel.isAClass(i)},d=function(t,i){return t&&"process"===t||!t&&e.Cmdbuild.dataModel.isAClass(i)},r=function(e,a){return n(e,a)?t:d(e,a)?i:void 0},s=function(t){var i=e("<div></div>").attr("id",t);i.dialog({autoOpen:!1,modal:!0,show:{effect:"fade",duration:250},hide:{effect:"explode",duration:500}})}}(jQuery),function($){var scripts={init:function(e){$.Cmdbuild.eventsManager.onEvent(e)},htmlText:function(e){$("#"+e.id).cleditor()},spinner:function(e){var t=e.max,i=e.min;$("#"+e.id).spinner({spin:function(a,n){return n.value>t?($(this).spinner("value",t),!1):n.value<i?($(this).spinner("value",i),!1):void $.Cmdbuild.eventsManager.onEvent(e.spin)},change:function(a,n){return n.value>t?($(this).spinner("value",t),!1):n.value<i?($(this).spinner("value",i),!1):void $.Cmdbuild.eventsManager.onEvent(e.spin)}})},lookup:function(param){try{param.readOnly||($("#"+param.id).selectmenu(),$("#"+param.id).selectmenu({select:function(event,ui){var val=$.Cmdbuild.utilities.getHtmlFieldValue("#"+param.id);param.value=val,$.Cmdbuild.custom.commands&&$.Cmdbuild.custom.commands.fieldChanged?$.Cmdbuild.custom.commands.fieldChanged(param):$.Cmdbuild.standard.commands.fieldChanged(param);var onchange=$("#"+param.id).attr("onChange");eval(onchange)}}));var objectField=new $.Cmdbuild.standard.lookupField(param);$("#"+param.id)[0].objectField=objectField}catch(e){throw $.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.scripts.lookup "+e.message),e}},select:function(param){try{$("#"+param.id).selectmenu(),$("#"+param.id).selectmenu({select:function(event,ui){var val=$.Cmdbuild.utilities.getHtmlFieldValue("#"+param.id);param.value=val,$.Cmdbuild.custom.commands&&$.Cmdbuild.custom.commands.fieldChanged?$.Cmdbuild.custom.commands.fieldChanged(param):$.Cmdbuild.standard.commands.fieldChanged(param);var onchange=$("#"+param.id).attr("onChange");eval(onchange)}});var objectField=new $.Cmdbuild.standard.selectField(param);$("#"+param.id)[0].objectField=objectField}catch(e){$.Cmdbuild.errorsManager.log(e)}},reference:function(param){try{param.readOnly||($("#"+param.id).selectmenu(),$("#"+param.id).selectmenu({select:function(event,ui){var val=$.Cmdbuild.utilities.getHtmlFieldValue("#"+param.id);param.value=val,$.Cmdbuild.custom.commands&&$.Cmdbuild.custom.commands.fieldChanged?$.Cmdbuild.custom.commands.fieldChanged(param):$.Cmdbuild.standard.commands.fieldChanged(param);var onchange=$("#"+param.id).attr("onChange");eval(onchange)}}));var objectField=new $.Cmdbuild.standard.referenceField(param);$("#"+param.id)[0].objectField=objectField}catch(e){throw $.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.scripts.lookup "+e.message),e}},checkbox:function(e){$('input[type="checkbox"][id="'+e.id+'"]').change(function(){this.checked?$('label[for="'+e.id+'"]').addClass("checked"):$('label[for="'+e.id+'"]').removeClass("checked")})},integer:function(e){
try{}catch(t){throw t.message!=$.Cmdbuild.errorsManager.CMERROR&&(t.message+="\n$.Cmdbuild.standard.scripts.integer"),$.Cmdbuild.errorsManager.log(t),t}},openMenu:function(e){try{$("#"+e.id).tooltip({content:$("#"+e.id).attr("title")})}catch(t){throw t.message!=$.Cmdbuild.errorsManager.CMERROR&&(t.message+="\n$.Cmdbuild.standard.scripts.openMenu"),$.Cmdbuild.errorsManager.log(t),t}},date:function(e){try{var t=$("#"+e.id);switch(e.type){case"timestamp":t.datetimepicker({dateFormat:"dd/mm/yy",timeFormat:"HH:mm:ss"});break;case"time":t.timepicker({timeFormat:"HH:mm:ss"});break;case"dateTime":t.datetimepicker({dateFormat:"dd/mm/yy",timeFormat:"HH:mm:ss"});break;case"date":t.datepicker({dateFormat:"dd/mm/yy"})}}catch(i){throw i.message!=$.Cmdbuild.errorsManager.CMERROR&&(i.message+="\n$.Cmdbuild.standard.scripts.date"),$.Cmdbuild.errorsManager.log(i),i}},dialog:function(e){$("#"+e.id).dialog({autoOpen:!1,modal:!0,beforeClose:e.callback?e.callback:function(){},show:{effect:"fade",duration:250},hide:{effect:"explode",duration:500}})},menu:function(e){$("#"+e.id).menu()},grid:function(e){try{e.backend=$.Cmdbuild.utilities.getBackend(e.backend)}catch(t){throw t.message!=$.Cmdbuild.errorsManager.CMERROR&&(t.message+="\n$.Cmdbuild.standard.scripts.grid"),$.Cmdbuild.errorsManager.log(t),t}},button:function(e){$("#"+e.id).button({icons:{primary:e.icon},text:!1}).click(function(e){e.preventDefault()})},graph:function(e){var t={defaultNodeColor:"#ec5148",defaulLabelColor:"#99f",defaultEdgeColor:"#aaa",edgeColor:"default",labelSizeRatio:".5",labelThreshold:.1},i=new sigma({container:e.id,settings:t});visit(e.className,e.cardId,e.description,{},{},{},i),i.startForceAtlas2()}};$.Cmdbuild.standard.scripts=scripts}(jQuery),function(e){var t=function(t){this.param=t,this.backend=void 0,this.loadLookup=function(){var t=[],i=e("#"+this.param.id),a="$fromBackend"==this.param.value?this.backend.getValue():this.param.value;this.param.hideEmptyOption||t.push("<option entryValue='' "+(this.param.value?"":"selected")+"></option>");for(var n=0;n<this.backend.data.length;n++){var d=this.backend.data[n],r=a&&a==d._id?"selected":"",s=" entryValue='"+d._id+"' ",l=" value='"+d._id+"' ";t.push("<option "+s+r+l+">"+d.description+"</option>")}i.empty(),i.append(t.join("")).selectmenu(),i.selectmenu("refresh"),i.trigger("change"),this.onInitComplete()},this.init=function(){try{var i=e.Cmdbuild.utilities.getBackend(t.backend);this.backend=new i(this.param,this.loadLookup,this)}catch(a){e.Cmdbuild.errorsManager.log(a)}},this.onInitComplete=function(){this.param.refreshGridAfterInit&&e.Cmdbuild.standard.commands.refreshGrid({form:this.param.refreshGridAfterInit})},this.init()};e.Cmdbuild.standard.selectField=t,e.Cmdbuild.standard.selectField.setValue=function(t,i){var a=e("#"+t);a.val(""),a.selectmenu("refresh")},e.Cmdbuild.standard.selectField.clearValue=function(t){var i=e("#"+t);i.val(""),i.selectmenu("refresh")}}(jQuery),function(e){var t=function(){this.param=void 0,this.forms=[],this.init=function(t){try{this.param=t,this.show()}catch(i){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.init"),i}},this.show=function(){try{var t=e.Cmdbuild.elementsManager.getElement(this.param.form);this.forms=this.getForms(t),this.prepareParams(this.forms),this.includeForms()}catch(i){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.show"),i}},this.showCB=function(){try{var t=e.Cmdbuild.elementsManager.getElement(this.param.form);e.Cmdbuild.eventsManager.deferEvents();var i=e.Cmdbuild.elementsManager.getXmlElementId(t);this.forms=this.getForms(t);var a="<div id='"+i+"'>";a+=this.insertTitles(this.forms),a+=this.insertForms(this.forms),a+="</div>";var n=e("#"+this.param.container)[0];n.innerHTML=a,e.Cmdbuild.elementsManager.initialize(),e.Cmdbuild.eventsManager.unDeferEvents(),e("#"+i).tabs({activate:function(t,i){e(e.fn.dataTable.tables(!0)).DataTable().columns.adjust(),e.Cmdbuild.standard.tabbed.fireChangeTab(i.newPanel[0].id)}})}catch(d){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.show"),d}},this.getForms=function(t){var i=[],a=e(t);return a.children("form").each(function(t){var a=e(this),n=e.Cmdbuild.elementsManager.getParams(a),d=e.Cmdbuild.utilities.getFields(a);d&&e.Cmdbuild.dataModel.putFormFields(d);var r=a.attr("title"),s=a.attr("i18nTitle");s&&(r=e.Cmdbuild.translations.getTranslation(s,r)),i.push({form:this,title:r,id:a.attr("id"),include:a.attr("include"),classes:a.attr("class"),invisible:a.attr("invisible"),params:n})}),i},this.prepareParams=function(t){try{for(var i=0;i<t.length;i++)t[i].params&&e.Cmdbuild.dataModel.prepareCallerParameters(t[i].id,t[i].params)}catch(a){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.prepareParams"),a}},this.insertTitles=function(t){try{var i="";i+="<ul>";for(var a=0;a<t.length;a++){var n="";"true"===t[a].invisible&&(n=" class='invisible' "),i+="<li "+n+"><a href='#"+t[a].id+"'>"+t[a].title+"</a></li>"}return i+="</ul>"}catch(d){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.insertTitles"),d}},this.includeForms=function(){if(this.forms.length<=0)return void this.showCB();var t=this.forms[0];this.forms.splice(0,1),e.Cmdbuild.utilities.include(t.form,this.includeForms,{},this)},this.insertForms=function(t){try{for(var i="",a=0;a<t.length;a++)i+="<div id='"+t[a].id+"' class='"+t[a].classes+"'>",i+=e.Cmdbuild.elementsManager.insertChildren(t[a].form),i+="</div>";return i}catch(n){throw e.Cmdbuild.errorsManager.log("$.Cmdbuild.standard.tabbed.insertForms"),n}}};e.Cmdbuild.standard.tabbed=t,e.Cmdbuild.standard.tabbed.fireChangeTab=function(t){var i=e.Cmdbuild.elementsManager.getElement(t);e.Cmdbuild.dataModel.pushParametersOnStack(t);var a=e.Cmdbuild.elementsManager.getEvent("onClick",i);e.Cmdbuild.eventsManager.onEvent(a)}}(jQuery),function(e){var t={getWidgetDiv:function(t){try{htmlStr="";var i=this.createXmlDiv(t.form,t.widgets,t.container,t.readOnly);return htmlStr+=e.Cmdbuild.elementsManager.toHtml(i),htmlStr+=this.createAllPopups(t.form,t),htmlStr}catch(a){e.Cmdbuild.errorsManager.popup(a)}},createXmlDiv:function(t,i,a,n){var d="<div";d+=" class='ui-widget-content ui-corner-all cmdbuild-widget-container' ",d+=" withReturn='true' ",d+=">";for(var r=0;r<i.length;r++)d+=this.createXmlButton(t,i[r],a,n);d+="</div>";for(var r=0;r<i.length;r++){var s=e.Cmdbuild.standard.widgetDiv.widgetName(i[r].type);e.Cmdbuild.widgets[s]&&e.Cmdbuild.widgets[s].cleanData(t,i[r])}var l=new DOMParser;return xDoc=l.parseFromString(d,"text/xml"),xDoc.documentElement},createXmlButton:function(e,t,i,a){var n=e+"_"+t._id,d="<button ";return d+=" id='"+n+"' ",d+=" text='"+t.label+"' ",d+=">",d+="<onClick>",d+="<command>navigate</command>",d+="<dialog>"+n+"_widgetDialog</dialog>",d+="<container>"+i+"</container>",d+="<form>"+n+"_dialogForm</form>",d+="<title>"+t.label+"</title>",d+="</onClick>",d+="<params>",d+="<dialog>"+n+"_widgetDialog</dialog>",d+="<widgetId>"+n+"</widgetId>",d+="<widgetClassName>"+t.data.className+"</widgetClassName>",d+="<singleSelect>"+t.data.singleSelect+"</singleSelect>",d+="<formData>"+e+"</formData>",d+="<selection>"+(1==t.data.noSelect?"false":"true")+"</selection>",d+="<editable>"+t.data.allowCardEditing+"</editable>",d+="<readOnly>"+("true"==a?"true":"false")+"</readOnly>",d+="<widgetName>"+n+"</widgetName>",d+="</params>",d+="</button>"},createXmlDialog:function(e){var t="<dialog id='"+e+"_widgetDialog'></dialog>",i=new DOMParser;return xDoc=i.parseFromString(t,"text/xml"),xDoc.documentElement},createAllPopups:function(t,i){for(var a="",n=0;n<i.widgets.length;n++){var d=t+"_"+i.widgets[n]._id,r={data:i.widgets[n].data,form:t};if(e.Cmdbuild.dataModel.getWidgetWindow(d))e.Cmdbuild.dataModel.substituteWidgetWindow(d,r);else{var s=this.createXmlDialog(d);a+=e.Cmdbuild.elementsManager.toHtml(s),e.Cmdbuild.dataModel.putWidgetWindow(d,r)}this.widgetForm(d,i,i.widgets[n])}return a},widgetForm:function(t,i,a){var n="<form title='Example' id='"+t+"_dialogForm'";if(a.data&&a.data.template)n+=' include="'+a.data.template+'"';else{var d=e.Cmdbuild.standard.widgetDiv.widgetName(a.type)+".xml";n+=" include='widgets/"+d+"'",n+=" fileType='core'"}n+=" withId='"+t+"'",n+=" class='cmdbuildTabbedForm'/>";var r=new DOMParser;xDoc=r.parseFromString(n,"text/xml");var s=xDoc.documentElement,l=e.Cmdbuild.elementsManager.getElement(i.container);l.appendChild(s)},getFiter:function(e){var t="";return t}};e.Cmdbuild.standard.widgetDiv=t,e.Cmdbuild.standard.widgetDiv.widgetName=function(e){var t=e.split(".");return t[t.length-1]}}(jQuery),function(e){var t={SAVEONCARD:"SAVEONCARD",SAVEAFTER:"SAVEAFTER",getWidgetsData:function(t,i){var a={};if(!i)return a;for(var n=0;n<i.length;n++){var d=e.Cmdbuild.standard.widgetDiv.widgetName(i[n].type);e.Cmdbuild.widgets[d]?a[i[n]._id]={data:e.Cmdbuild.widgets[d].save(t,i[n]),saveType:e.Cmdbuild.widgets[d].saveMethod,widgetType:i[n].type}:console.log("Widget "+d+" not found!")}return a},saveOnDataWidgets:function(t,i){var a=[];for(var n in i){var d=i[n],r={};if(d.saveType==e.Cmdbuild.widgets.SAVEONCARD){for(var s in d.data)r[s]={};a.push({_id:n,output:r})}}t._widgets=a},savePostponedWidgets:function(e,t,i,a,n,d){var r=e.slice();this.savePostponedWidgetsRecursive(r,t,i,a,function(){n.apply(d,[])},this)},savePostponedWidgetsRecursive:function(t,i,a,n,d,r){if(t.length<=0)return void d.apply(r,[]);var s=t[0];t.splice(0,1);var l=i[s._id];if(!l)return void d.apply(r,[]);if(l.saveType==e.Cmdbuild.widgets.SAVEAFTER){var o=e.Cmdbuild.standard.widgetDiv.widgetName(l.widgetType);e.Cmdbuild.widgets[o].flush(a,i[s._id].data,s._id,n,function(){this.savePostponedWidgetsRecursive(t,i,a,n,d,r)},this)}else this.savePostponedWidgetsRecursive(t,i,a,n,d,r)},evaluateCqlFields:function(t,i){for(var a=0;a<i.length;a++){var n=i[a],d=e.Cmdbuild.standard.widgetDiv.widgetName(n.type);e.Cmdbuild.widgets[d]&&e.Cmdbuild.widgets[d].evaluateCql&&e.Cmdbuild.widgets[d].evaluateCql(t,n)}},initialize:function(t,i){for(var a=0;a<i.length;a++){var n=i[a],d=e.Cmdbuild.standard.widgetDiv.widgetName(n.type);e.Cmdbuild.widgets[d]&&e.Cmdbuild.widgets[d].initialize&&e.Cmdbuild.widgets[d].initialize(t,n)}},refreshCqlField:function(t,i){void 0===i&&(i=[]);for(var a=0;a<i.length;a++){var n=i[a],d=e.Cmdbuild.standard.widgetDiv.widgetName(n.type);e.Cmdbuild.widgets[d]&&e.Cmdbuild.widgets[d].refreshCqlField&&e.Cmdbuild.widgets[d].refreshCqlField(t,n)}},refreshTemplate:function(t,i,a){for(var n=0;n<i.length;n++){var d=i[n],r=e.Cmdbuild.standard.widgetDiv.widgetName(d.type);e.Cmdbuild.widgets[r]&&e.Cmdbuild.widgets[r].refreshTemplate&&e.Cmdbuild.widgets[r].refreshTemplate(t,i[n],a)}},prepareFields:function(t){for(var i=0;i<t.length;i++){var a=t[i],n=e.Cmdbuild.standard.widgetDiv.widgetName(a.type);e.Cmdbuild.widgets[n]&&e.Cmdbuild.widgets[n].prepareFields&&e.Cmdbuild.widgets[n].prepareFields(a)}}};e.Cmdbuild.widgets=t}(jQuery);
//# sourceMappingURL=standard.min.js.map