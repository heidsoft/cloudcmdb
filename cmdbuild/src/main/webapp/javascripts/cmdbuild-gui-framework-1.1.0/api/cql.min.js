function Configurator(output){var HOOKMANAGERNOTDEFINED="Non e' stato definito un manager Cql";this.debug=!1,this.output=output,this.output({type:"debug",msg:"Configurator!"}),this.manager={xa:{isVariableManager:!0,getValue:function(t,e,i,a){var r=e.split(".");2==r.length&&"Id"==r[1]?i.apply(a,[4444]):i.apply(a,["xa__"+t+" "+e])}},user:{isVariableManager:!0,getValue:function(t,e,i,a){var r=$.Cmdbuild.authentication.getAuthenticationToken();$.Cmdbuild.utilities.proxy.getSession(r,function(t){var e={page:0,start:0,limit:1,filter:{attribute:{simple:{attribute:"Username",operator:"equal",value:[t[0].username]}}},filterType:"attribute"};$.Cmdbuild.utilities.proxy.getCardList("User",e,function(t,e){t.length&&i.apply(a,[t[0]._id])},this)},this,[])}},client:{isVariableManager:!0,getValue:function(t,e,i,a){var r=$.Cmdbuild.elementsManager.getElement(t),s={};$.Cmdbuild.elementsManager.getParams(r,s);var n=$.Cmdbuild.dataModel.forms[t],l=e.split(".");if(l.length>1&&"DESCRIPTION"==l[1].toUpperCase()){var o={field:l[0],form:t};n.getClientDescription(o,function(t){i.apply(a,[t])},this)}else{var u=n.getValue({field:l[0],form:t});i.apply(a,[u||void 0])}}},server:{isVariableManager:!0,getValue:function(t,e,i,a){try{var r=$.Cmdbuild.dataModel.forms[t],s=e.split(".");if(s.length>1&&"DESCRIPTION"==s[1].toUpperCase()){var n={field:s[0],form:t};r.getServerDescription(n,function(t){i.apply(a,[t])},this)}else{var l=$.Cmdbuild.dataModel.getValue(t,s[0]);i.apply(a,[l||void 0])}}catch(o){console.log("Error on server variable "+t+" "+e+" "+o.message),i.apply(a,[void 0])}}},cql:{isVariableManager:!1,getValue:function(t,e,i,a){if(-1!=e.indexOf($.Cmdbuild.global.CQLUNDEFINEDVALUE))return void i.apply(a,[void 0]);var r={filter:{CQL:e}};$.Cmdbuild.utilities.proxy.getCqlResult(r,function(t){i.apply(a,[t])},this)}},js:{isVariableManager:!1,getValue:function(t,e,i,a){var r=new RegExp($.Cmdbuild.global.CQLUNDEFINEDVALUE,"g"),s=e.replace(r,"undefined"),n=this.safeJSEval(s);i.apply(a,[n])},safeJSEval:function(stringTOEvaluate){var resultOfEval="";output({type:"debug",msg:"***********safeJSEval "+stringTOEvaluate});try{resultOfEval=eval(stringTOEvaluate)}catch(e){try{resultOfEval=eval(stringTOEvaluate.replace(/(\r\n|\r|\n|\u0085|\u000C|\u2028|\u2029)/g,""))}catch(ee){output({type:"debug",msg:"Error evaluating javascript expression "+stringTOEvaluate})}}return output({type:"debug",msg:"***********safeJSEval evaluated "+resultOfEval}),resultOfEval}}},this.changed=function(t,e){var i={form:t,field:e};$.Cmdbuild.custom.commands&&$.Cmdbuild.custom.commands.fieldRefresh?$.Cmdbuild.custom.commands.fieldRefresh(i):$.Cmdbuild.standard.commands.fieldRefresh(i)}}function cqlEvaluate(t,e,i){var a=function(t){console.log("cql.manager: "+t.msg)},r=new Configurator(a),s=new CqlManager(r),n={};for(var l in t.meta)s.lexer.analize(t.meta[l]),n[l]=new treeObject(r,s.lexer.tree,null,t.form);s.lexer.analize(t.filter);var o=new treeObject(r,s.lexer.tree,n,t.form);o.resolve(function(t){e.apply(i,[t])},this)}function CqlManager(t){this.configurator=t,this.lexer=new lexer(this.configurator),this.commandsTable=new commandsTable(this.configurator),this.metaTable=new commandsTable(this.configurator),this.variablesTable=new variablesTable(this.configurator),this.compile=function(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.filter&&a.filter.text&&this.compileAttribute(t,a)}this.variablesTable.generate(t,this.commandsTable)},this.compileAttribute=function(t,e){if(e.filter&&e.filter.text){this.lexer.analize(e.filter.text),this.commandsTable.prepareEntry(t,e.name);var i=this.lexer.tree.slice();for(var a in e.filter.params){this.lexer.analize(e.filter.params[a]);var r=a.split("."),s=r[r.length-1];this.commandsTable.pushMeta(t,e.name,s,this.lexer.tree)}this.commandsTable.push(t,e.name,i)}},this.onFilterChanged=function(t){alert(t.form+" "+t.field)},this.fieldChanged=function(t,e){this.variablesTable.fieldChanged(t,e)},this.resolve=function(t,e,i,a){this.commandsTable.resolve(t,e,function(t){i.apply(a,[t])},this)},this.isUndefined=function(t){return-1!=t.indexOf($.Cmdbuild.global.CQLUNDEFINEDVALUE)}}function lexer(t){this.configurator=t,this.CQLSINTAXERRORBADFORMATTEDCOMMAND="Cql sintax error bad formatted command",this.tree=[],this.stack=[],this.stackPointer=0,this.originalCommand="",this.analize=function(t){if(this.stackPointer=0,this.tree=[],this.stack=[this.tree],this.originalCommand=t,this.stackStrings=[],this._analize(" "+t,!1),0!=this.stackPointer){console.log(this.CQLSINTAXERRORBADFORMATTEDCOMMAND+" "+this.originalCommand);var e=new Error({message:this.CQLSINTAXERRORBADFORMATTEDCOMMAND+" "+this.originalCommand});throw e}},this._analize=function(t,e){if(""!=t){this.stackStrings.push(t);var i=t.indexOf("{"),a=t.indexOf("}");if(this.stackPointer<0){console.log(this.CQLSINTAXERRORBADFORMATTEDCOMMAND+" "+t+" "+this.originalCommand,this.stackStrings);var r=new Error({message:this.CQLSINTAXERRORBADFORMATTEDCOMMAND+" "+this.originalCommand});throw r}if(-1==a&&-1==i){var s=t;this.pushToken(s,e)}else if(i>a||-1==i){var s=t.substr(0,a);this.pushToken(s,e),this.stackPointer+="{"===t.substr(a+1,1)?0:-1,this._analize(t.substr(a+1),!1)}else if(0==i)this._analize(t.substr(i+1),!0);else{var s=t.substr(0,i),n=this.stack[this.stackPointer];this.pushToken(s,e),n.push([]),this.stackPointer+=1,this.stack[this.stackPointer]=n[n.length-1],this._analize(t.substr(i),!1)}}},this.pushToken=function(t,e){var i=this.stack[this.stackPointer];if(""!=t){var a=t.split(":");2==a.length&&e?i.push({type:"object",manager:a[0],value:a[1]}):i.push({type:"text",value:t})}}}function variablesTable(t){this.configurator=t,this.table={},this.generate=function(t,e){this.table[t]=[];var i=e.getForm(t);if(i)for(var a in i){var r=e.getTree(t,a),s=e.getMeta(t,a);if(!r)return;this.generateVariables(t,a,r.getTree(),s)}},this.generateVariables=function(t,e,i,a){for(var r=0;r<i.length;r++)if(void 0==i[r].type)this.generateVariables(t,e,i[r],a);else if("object"==i[r].type){var s=i[r].value.split(".");this.table[t].push({form:t,field:e,manager:i[r].manager,variable:s[0]})}if(a)for(var n in a)this.generateVariables(t,e,a[n].getTree(),null)},this.fieldChanged=function(t,e){var i={};if(!this.table[t])return void console.log("No dependancies for "+t+"."+e);for(var a=0;a<this.table[t].length;a++){var r=this.table[t][a];r.variable!=e||i[r.field]||(i[r.field]=!0,this.isVariableManager(r.manager)||this.fieldChanged(t,r.field))}for(var s in i)this.configurator.changed(t,s)},this.debug=function(){for(var t in this.table)for(var e=0;e<this.table[t].length;e++){var i=this.table[t][e];this.configurator.output({type:"debug",msg:i.form+"|"+i.field+"|"+i.variable+"|"+i.manager})}},this.isVariableManager=function(t){return this.configurator.manager[t].isVariableManager}}function commandsTable(t){this.configurator=t,this.table={},this.prepareEntry=function(t,e){this.table[t]||(this.table[t]={}),this.table[t][e]={}},this.push=function(e,i,a){this.table[e][i].tree=new treeObject(t,a,this.getMeta(e,i),e)},this.pushMeta=function(e,i,a,r){this.table[e][i].meta||(this.table[e][i].meta={}),this.table[e][i].meta[a]=new treeObject(t,r,this.getMeta(e,i),e)},this.getForm=function(t){return this.table[t]?this.table[t]:void 0},this.getTree=function(t,e){return this.table[t]&&this.table[t][e]?this.table[t][e].tree:null},this.getMeta=function(t,e){return this.table[t]&&this.table[t][e]?this.table[t][e].meta:null},this.resolve=function(t,e,i,a){this.getTree(t,e)?this.getTree(t,e).resolve(function(t){i.apply(a,[t])},this):i.apply(a,[""])},this.debug=function(){for(var t in this.table)for(var e in this.table[t]){var i=t+"|"+e;i+="|"+this.getTree(t,e).write(),this.configurator.output({type:"debug",msg:i});for(var a in this.getMeta(t,e)){var i=t+" "+e+"-->meta-->"+a;i+="|"+this.getMeta(t,e)[a].write(),this.configurator.output({type:"debug",msg:i})}}},this.isVariableManager=function(t){return this.configurator.manager[t].isVariableManager}}function treeObject(t,e,i,a){this.configurator=t,this.tree=e,this.meta=i,this.form=a,this.getTree=function(){return this.tree},this.write=function(){return this.writeTree(this.tree)},this.writeTree=function(t){for(var e="",i=0;i<t.length;i++)e+=void 0==t[i].type?"+"+this.writeTree(t[i]):"object"==t[i].type?"+["+t[i].manager+"]"+t[i].value:"+"+t[i].value;return e},this.resolve=function(t,e){if(null==this.tree||this.tree.length<=0)return void t.apply(e,[""]);try{var i=this.tree.slice();this.resolveTree(i,"",function(i){t.apply(e,[i])},this)}catch(a){t.apply(e,[void 0])}},this.resolveTree=function(t,e,i,a){if(t.length<=0)return void i.apply(a,[e]);var r=t[0];if(t.splice(0,1),void 0==r.type){var s=r.slice();this.resolveTree(s,"",function(r){this.resolveTree(t,e+r,i,a)},this)}else if("object"==r.type){var n="",l=r.value.split(".");this.isInMyMeta(l[0])?this.resolveMeta(l[0],function(s){void 0==s&&(s=$.Cmdbuild.global.CQLUNDEFINEDVALUE,this.resolveTree(t,e+s,i,a)),this.evaluate(r.manager,this.form,s,function(s){var n=r.value.split(".");void 0===s&&(s=$.Cmdbuild.global.CQLUNDEFINEDVALUE),n.length>1&&s.length>0&&(s=s[0][n[1]]),this.resolveTree(t,e+s,i,a)},this)},this):(n=r.value,this.evaluate(r.manager,this.form,n,function(r){void 0===r&&(r=$.Cmdbuild.global.CQLUNDEFINEDVALUE),this.resolveTree(t,e+r,i,a)},this))}else this.resolveTree(t,e+r.value,i,a)},this.isInMyMeta=function(t){return this.meta?this.meta&&this.meta[t]:!1},this.resolveMeta=function(t,e,i){this.meta[t].resolve(function(t){e.apply(i,[t])},this)},this.evaluate=function(t,e,i,a,r){this.configurator.manager[t]?this.configurator.manager[t].getValue(e,i,function(t){a.apply(r,[t])},this):output(HOOKMANAGERNOTDEFINED+": "+t)}}function configurator(t){var e="Non e' stato definito un manager Cql";this.debug=!1,this.manager={xa:{getValue:function(i,a){t(e+": xa")}},client:{getValue:function(i,a){t(e+": client")}},server:{getValue:function(i,a){t(e+": server")}}},this.changed=function(t){},this.output=function(e){t(e)}}
//# sourceMappingURL=cql.min.js.map